<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Manager</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .nav-button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .income-btn {
            background-color: #2ecc71;
            color: white;
        }
        .expense-btn {
            background-color: #e74c3c;
            color: white;
        }
        .transfer-btn {
            background-color: #3498db;
            color: white;
        }
        .form-container {
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        .form-section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin: 10px 0;
        }
        .form-section.active {
            display: block;
        }
        .account-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 900px;
            display: inline-block;
            vertical-align: top;
            cursor: move;
            user-select: none;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .account-card.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .account-card.drag-over {
            border: 2px dashed #3498db;
        }
        #accountsContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 10px;
            min-height: 100px;
        }
        .transaction-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        input, select {
            margin: 5px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: calc(100% - 26px);
        }
        button {
            margin: 5px;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .submit-btn {
            background-color: #4CAF50;
            color: white;
            width: 100%;
            padding: 12px;
            margin-top: 15px;
        }
        .balance {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .income {
            color: #2ecc71;
        }
        .expense {
            color: #e74c3c;
        }
        .search-container {
            margin: 20px 0;
        }
        
        .search-input {
            width: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-right: 10px;
        }
        
        .search-results-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .search-results-content {
            position: relative;
            background-color: white;
            margin: 50px auto;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .close-search {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin: 5px 0;
        }
        
        .search-result-item:hover {
            background-color: #f5f5f5;
        }
        
        .highlight {
            background-color: yellow;
            padding: 2px;
        }
        
        .account-name {
            cursor: pointer;
        }
        
        .account-name:hover {
            color: #3498db;
        }

        .rename-input {
            font-size: 1.5em;
            padding: 5px;
            margin: 5px 0;
            width: 80%;
        }

        .transactions-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .transactions-container.expanded {
            max-height: 400px;
        }

        .expand-button {
            background: none;
            border: none;
            color: #666;
            padding: 5px 10px;
            margin: 10px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            width: 100%;
            justify-content: space-between;
        }

        .expand-button:hover {
            background-color: #f5f5f5;
        }

        .expand-button::after {
            content: '▼';
            font-size: 12px;
            transition: transform 0.3s;
        }

        .expand-button.expanded::after {
            transform: rotate(180deg);
        }

        .transactions-scroll {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            pointer-events: auto !important;
        }

        /* Custom scrollbar styling */
        .transactions-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .transactions-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .transactions-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .transactions-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .carousel-container {
            position: relative;
            width: 95%;
            max-width: 1000px;
            margin: 0 auto;
            overflow: hidden;
        }

        .carousel-wrapper {
            display: flex;
            transition: transform 0.3s ease-in-out;
            min-height: 200px;
        }

        .account-card {
            width: 100%;
            min-width: 100%;
            margin: 0;
            padding: 20px;
            flex: 0 0 100%;
            box-sizing: border-box;
        }

        #accountsContainer {
            display: flex;
            transition: transform 0.3s ease-in-out;
            gap: 0;
            padding: 0;
            flex-wrap: nowrap;
        }

        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 40px;
            height: 50px;
            cursor: pointer;
            z-index: 10;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-button.prev {
            left: 0;
        }

        .carousel-button.next {
            right: 0;
        }

        .carousel-indicator {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            gap: 5px;
        }

        .indicator-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
            cursor: pointer;
        }

        .indicator-dot.active {
            background: #3498db;
        }

        /* Hide account selects in income/expense forms */
        #incomeForm select, #expenseForm select {
            display: none;
        }

        .balance, .income, .expense {
            font-size: 1.5em;
            margin: 10px 0;
        }

        .transaction-section {
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
        }

        .transaction-section h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .transactions-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin: 10px 0;
        }

        .transactions-row {
            display: flex;
            gap: 20px;
            width: 100%;
        }

        .income-transactions,
        .expense-transactions {
            flex: 1;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .income-transactions.expanded,
        .expense-transactions.expanded {
            max-height: 400px;
        }

        .expand-button {
            margin: 2px 0;
            justify-content: center;
            pointer-events: auto !important;
        }

        .expand-button::after {
            margin-left: 10px;
        }

        .import-export-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-buttons {
            margin: 20px 0;
        }

        .search-container {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-input {
            width: 300px;
            padding: 8px;
        }

        .delete-account-btn {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .delete-account-btn:hover {
            background-color: #c0392b !important;
        }

        /* Add modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close-modal:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Expense Manager</h1>
        
        <div class="import-export-section">
            <input type="file" id="importFile" style="display: none;" accept=".json">
            <button onclick="document.getElementById('importFile').click()" class="nav-button" style="background-color: #f39c12;">
                Import Transactions
            </button>
            <button onclick="exportData()" class="nav-button" style="background-color: #f39c12;">
                Export Transactions
            </button>

            <!-- ADD THESE NEW BUTTONS AND INPUT -->
            <input type="file" id="importCategoriesFile" style="display: none;" accept=".json">
            <button onclick="document.getElementById('importCategoriesFile').click()" class="nav-button" style="background-color: #9b59b6;">
                Import Categories
            </button>
            <button onclick="exportCategories()" class="nav-button" style="background-color: #9b59b6;">
                Export Categories
            </button>
            <!-- END OF ADDITION -->
        </div>

        <div class="carousel-container">
            <button class="carousel-button prev" onclick="moveCarousel(-1)">❮</button>
            <button class="carousel-button next" onclick="moveCarousel(1)">❯</button>
            <div class="carousel-wrapper" id="accountsContainer"></div>
        </div>
        <div class="carousel-indicator" id="carouselIndicator"></div>

        <div class="nav-buttons">
            <button class="nav-button income-btn" onclick="showForm('income')">Income</button>
            <button class="nav-button expense-btn" onclick="showForm('expense')">Expense</button>
            <button class="nav-button transfer-btn" onclick="showForm('transfer')">Transfer</button>
        </div>

        <div class="form-container">
            <div id="incomeForm" class="modal">
                <div class="modal-content">
                    <span class="close-modal" onclick="hideForm('income')">&times;</span>
                    <h2>Add Income</h2>
                    <select id="incomeAccount"></select>
                    <input type="number" id="incomeAmount" placeholder="Amount">
                    <input type="text" id="incomeDescription" placeholder="Description">
					<input type="text" id="incomeCategory" placeholder="Category">
                    <button class="submit-btn" onclick="addIncome()">Add Income</button>
                </div>
            </div>

            <div id="expenseForm" class="modal">
                <div class="modal-content">
                    <span class="close-modal" onclick="hideForm('expense')">&times;</span>
                    <h2>Add Expense</h2>
                    <select id="expenseAccount"></select>
                    <input type="number" id="expenseAmount" placeholder="Amount">
                    <input type="text" id="expenseDescription" placeholder="Description">
					<input type="text" id="expenseCategory" placeholder="Category">
                    <button class="submit-btn" onclick="addExpense()">Add Expense</button>
                </div>
            </div>

            <div id="transferForm" class="modal">
                <div class="modal-content">
                    <span class="close-modal" onclick="hideForm('transfer')">&times;</span>
                    <h2>Transfer Between Accounts</h2>
                    <select id="fromAccount"></select>
                    <select id="toAccount"></select>
                    <input type="number" id="transferAmount" placeholder="Amount">
                    <input type="text" id="transferDescription" placeholder="Description">
					<input type="text" id="transferCategory" placeholder="Category">
                    <button class="submit-btn" onclick="transferFunds()">Transfer</button>
                </div>
            </div>
        </div>

        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Search transactions...">
            <button class="nav-button" onclick="searchTransactions()" style="background-color: #9b59b6;">
                Search Transactions
            </button>
        </div>

        <div style="margin-top: 20px;">
            <input type="text" id="newAccountName" placeholder="New account name" style="width: 200px;">
            <button class="nav-button" onclick="addAccount()" style="background-color: #2ecc71;">
                Add New Account
            </button>
        </div>
    </div>

    <div id="searchResultsModal" class="search-results-modal">
        <div class="search-results-content">
            <span class="close-search" onclick="closeSearchModal()">&times;</span>
            <h2>Search Results</h2>
            <div id="searchResults"></div>
        </div>
    </div>

    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="hideEditModal()">&times;</span>
            <h2>Edit Transaction</h2>
            <input type="hidden" id="editTransactionAccount">
            <input type="hidden" id="editTransactionDate">
            <input type="number" id="editTransactionAmount" placeholder="Amount">
            <input type="text" id="editTransactionDescription" placeholder="Description">
			<input type="text" id="editTransactionCategory" placeholder="Category">
            <button class="submit-btn" onclick="updateTransaction()">Update Transaction</button>
        </div>
    </div>

    <script>
        let accounts = [];
        let db;
        let currentSlide = 0;
		let categoryMap = {};

        // Initialize IndexedDB
		const initDB = () => {
			// Bump version to 2 to trigger onupgradeneeded for old DBs
			const request = indexedDB.open('ExpenseManagerDB', 3);

			request.onerror = (event) => {
				console.error('Database error:', event.target.error);
			};

			request.onupgradeneeded = (event) => {
				const db = event.target.result;

				// Create accounts store if missing
				if (!db.objectStoreNames.contains('accounts')) {
					db.createObjectStore('accounts', { keyPath: 'name' });
				}

				// Create categoryMap store if missing
				if (!db.objectStoreNames.contains('categoryMap')) {
					db.createObjectStore('categoryMap');
				}
			};

			request.onsuccess = (event) => {
				db = event.target.result;

				// Load accounts into memory
				loadFromStorage();

				// Only try to read categoryMap if it exists (avoids crash on old DBs)
				if (db.objectStoreNames.contains('categoryMap')) {
					const catTransaction = db.transaction(['categoryMap'], 'readonly');
					const catStore = catTransaction.objectStore('categoryMap');
					const catRequest = catStore.get('map');

					catRequest.onsuccess = () => {
						if (catRequest.result) {
							categoryMap = catRequest.result;
						} else {
							categoryMap = {};
						}
					};

					catRequest.onerror = () => {
						console.error('Error reading categoryMap from DB');
						categoryMap = {};
					};
				} else {
					categoryMap = {};
				}
			};
		};

        // Load accounts from IndexedDB
        function loadFromStorage() {
            const transaction = db.transaction(['accounts'], 'readwrite');
            const store = transaction.objectStore('accounts');
            const request = store.getAll();

            request.onsuccess = () => {
                accounts = request.result;
                
                // Convert all dates to timestamps
                accounts.forEach(account => {
                    account.transactions.forEach(transaction => {
                        if (typeof transaction.date !== 'number') {
                            transaction.date = new Date(transaction.date).getTime() || Date.now();
                        }
                    });
                });
                
                // Save converted data back
                const putTransaction = db.transaction(['accounts'], 'readwrite');
                const putStore = putTransaction.objectStore('accounts');
                accounts.forEach(account => putStore.put(account));
                
                accounts.sort((a, b) => (a.order || 0) - (b.order || 0));
                updateAccountSelects();
                renderAccounts();
            };
        }

        // Save accounts to IndexedDB
		function saveToStorage() {
			let storeNames = ['accounts'];
			if (db.objectStoreNames.contains('categoryMap')) {
				storeNames.push('categoryMap');
			}
			const transaction = db.transaction(storeNames, 'readwrite');

			// Save accounts
			const store = transaction.objectStore('accounts');
			store.clear();
			accounts.forEach(account => {
				store.add(account);
			});

			// Save category map
			if (db.objectStoreNames.contains('categoryMap')) {
				const catStore = transaction.objectStore('categoryMap');
				catStore.put(categoryMap, 'map');
			}
		}

        // Maintain transaction limit
		function maintainTransactionLimit(account) {
			const MAX_TRANSACTIONS = 500;
			// Ensure transactions are in chronological order (oldest first)
			account.transactions.sort((a, b) => a.date - b.date);
			while (account.transactions.length > MAX_TRANSACTIONS) {
				const removedTransaction = account.transactions.shift(); // removes oldest transaction
				// Roll its effect into the stored balance
				account.balance = (account.balance || 0) + 
					(removedTransaction.type === 'income' ? removedTransaction.amount : -removedTransaction.amount);
			}
		}
		
		function isCurrentMonth(timestamp) {
			const now = new Date();
			const date = new Date(timestamp);
			return date.getFullYear() === now.getFullYear() && date.getMonth() === now.getMonth();
		}

        // Export accounts to JSON file
        function exportData() {
            const dataToExport = accounts
                .filter(account => !account.isTotal) // Exclude Total account
                .map(account => ({
                    ...account,
                    transactions: account.transactions.map(transaction => ({
                        ...transaction,
                        date: Number(transaction.date), // Ensure date is numeric
						timestamp: new Date(Number(transaction.date)).toLocaleString('en-GB', {
							day: '2-digit',
							month: '2-digit',
							year: 'numeric',
							hour: '2-digit',
							minute: '2-digit',
							hour12: true
						}).replace(',', ' :')
                    }))
                }));

            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expense-manager-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
		

        // Import accounts from JSON file
		document.getElementById('importFile').addEventListener('change', function(e) {
			const file = e.target.files[0];
			if (!file) return;

			const reader = new FileReader();
			reader.onload = function(e) {
				try {
					const importedData = JSON.parse(e.target.result);
					
					// Validate imported data
					if (!Array.isArray(importedData)) throw new Error('Invalid file format');
					
					// Process imported accounts
					const newAccounts = importedData.map(account => {
						// Ensure each account has a balance property (default to 0 if not present)
						let a = {
							...account,
							balance: account.balance !== undefined ? account.balance : 0,
							transactions: account.transactions.map(t => ({
								type: t.type,
								amount: parseFloat(t.amount),
								description: t.description,
								category: t.category || '',
								date: t.date ? Number(t.date) : Date.now() // Handle legacy data
							}))
						};
						// Apply the transaction limit so that older transactions are trimmed
						maintainTransactionLimit(a);
						return a;
					});
					
					// Clear existing accounts (except the Total account)
					accounts = [createTotalAccount()];
					
					// Add imported accounts
					newAccounts.forEach(account => {
						if (!account.name || account.isTotal) return; // Skip invalid entries
						accounts.unshift(account);
					});

					// Save and refresh
					saveToStorage();
					renderAccounts();
					alert('Successfully imported ' + newAccounts.length + ' accounts!');
					
				} catch (error) {
					alert('Error importing data: ' + error.message);
				}
			};
			reader.readAsText(file);
		});
		
        function exportCategories() {
            if (Object.keys(categoryMap).length === 0) {
                alert('There are no categories to export.');
                return;
            }

            const blob = new Blob([JSON.stringify(categoryMap, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expense-manager-categories-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ADD THIS EVENT LISTENER BLOCK
        document.getElementById('importCategoriesFile').addEventListener('change', function(e) {
			const file = e.target.files[0];
			if (!file) return;

			const reader = new FileReader();
			reader.onload = function(e) {
				try {
					const importedCategories = JSON.parse(e.target.result);
					
                    // Basic validation to ensure it's an object
					if (typeof importedCategories !== 'object' || Array.isArray(importedCategories)) {
                        throw new Error('Invalid categories file format.');
                    }
					
                    // Merge with existing categories, overwriting duplicates
                    categoryMap = { ...categoryMap, ...importedCategories };

					saveToStorage(); // This will save the updated categoryMap to IndexedDB
					alert('Successfully imported and merged categories!');
					
				} catch (error) {
					alert('Error importing categories: ' + error.message);
				}
			};
			reader.readAsText(file);
		});		

        function showForm(formType) {
            // Hide all forms first
            document.getElementById('incomeForm').style.display = 'none';
            document.getElementById('expenseForm').style.display = 'none';
            document.getElementById('transferForm').style.display = 'none';
            
            // Show requested form
            const form = document.getElementById(formType + 'Form');
            form.style.display = 'flex';
            
            // Clear previous values
            form.querySelector('input[type="number"]').value = '';
            form.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
            
            // Focus on amount field
            form.querySelector('input[type="number"]').focus();
        }

        function hideForm(formType) {
            document.getElementById(formType + 'Form').style.display = 'none';
        }

        function updateAccountSelects() {
            const accountSelects = document.querySelectorAll('select[id$="Account"]');
            accountSelects.forEach(select => {
                select.innerHTML = accounts
                    .filter(a => !a.isTotal) // Exclude Total account
                    .map(a => `<option value="${a.name}">${a.name}</option>`)
                    .join('');
            });
        }

		function addAccount() {
			const accountName = document.getElementById('newAccountName').value;
			if (!accountName) return alert('Please enter an account name');
			
		    const positionInput = parseInt(prompt(
		 	 `Enter insertion position (0 to ${accounts.length}):`
		    ), 10);
		    const pos = Number.isInteger(positionInput)
		 	 ? Math.min(Math.max(positionInput, 0), accounts.length)
		 	 : accounts.length;

		    const newAccount = {
			  name: accountName,
			  transactions: [],
			  balance: 0,    // rolling–balance
			  order: pos     // temporary; will be overwritten below
		    };
		    // insert the new account object at index `pos`
		    accounts.splice(pos, 0, newAccount);

  		    // re-assign every account’s order to its index
		    accounts.forEach((acct, idx) => {
			  acct.order = idx;
		    });
							
			saveToStorage();
			updateAccountSelects();
			renderAccounts();
			document.getElementById('newAccountName').value = '';
		}

        function addIncome() {
            if (accounts.length === 0) {
                alert('Please create an account first');
                return;
            }

            const account = accounts[currentSlide];
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const description = document.getElementById('incomeDescription').value;

            if (!amount || amount <= 0) return alert('Please enter a valid amount');
			const incomeCategory = document.getElementById('incomeCategory').value.trim() || 'Uncategorized';
            account.transactions.push({
                type: 'income',
                amount,
                description,
				category: incomeCategory,
                date: Date.now() // Use timestamp in milliseconds
            });
			
			
			categoryMap[`income|${description.toLowerCase()}`] = incomeCategory;
			
            maintainTransactionLimit(account);
            saveToStorage();
            renderAccounts();
            hideForm('income');
        }

        function addExpense() {
            if (accounts.length === 0) {
                alert('Please create an account first');
                return;
            }

            const account = accounts[currentSlide];
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const description = document.getElementById('expenseDescription').value;

            if (!amount || amount <= 0) return alert('Please enter a valid amount');
		
			const expenseCategory = document.getElementById('expenseCategory').value.trim() || 'Uncategorized';
			
            account.transactions.push({
                type: 'expense',
                amount,
                description,
				category: expenseCategory,
                date: Date.now() // Use timestamp in milliseconds
            });
			
			
			categoryMap[`expense|${description.toLowerCase()}`] = expenseCategory;

            maintainTransactionLimit(account);
            saveToStorage();
            renderAccounts();
            hideForm('expense');
        }

        function transferFunds() {
            const fromAccount = document.getElementById('fromAccount').value;
            const toAccount = document.getElementById('toAccount').value;
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const description = document.getElementById('transferDescription').value;

            // Validate inputs
            if (!fromAccount || !toAccount) {
                alert('Please select both accounts');
                return;
            }
            if (fromAccount === toAccount) {
                alert('Cannot transfer between the same account');
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            // Check if either account is Total
            if (fromAccount === 'Total' || toAccount === 'Total') {
                alert('Cannot transfer to/from the Total account');
                return;
            }

            const source = accounts.find(a => a.name === fromAccount);
            const target = accounts.find(a => a.name === toAccount);

            // Check if source has enough balance with 0.01 tolerance
            const sourceBalance = calculateBalance(source);
            if (sourceBalance < (amount - 0.0001)) { // Allow for floating point precision errors
                alert(`Insufficient funds. Available balance: ${sourceBalance.toFixed(2)}`);
                return;
            }

            // Use exact amount from input
            const preciseAmount = parseFloat(amount.toFixed(2));
            
            const timestamp = Date.now();
            
            // Update transactions to use precise amounts
            source.transactions.push({
                type: 'expense',
                amount: preciseAmount,
                description: `Transfer to ${toAccount}: ${description}`,
				category: document.getElementById('transferCategory').value.trim() || 'Uncategorized',
                date: timestamp
            });
            
            target.transactions.push({
                type: 'income',
                amount: preciseAmount,
                description: `Transfer from ${fromAccount}: ${description}`,
				category: document.getElementById('transferCategory').value.trim() || 'Uncategorized',
                date: timestamp
            });

            // Maintain transaction limits
            maintainTransactionLimit(source);
            maintainTransactionLimit(target);

            // Clear form fields
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferDescription').value = '';

            // Save and update UI
            saveToStorage();
            renderAccounts();
            hideForm('transfer');
        }

		function calculateBalance(account) {
			const transactionsSum = account.transactions.reduce((total, t) => {
				return t.type === 'income' ? total + t.amount : total - t.amount;
			}, 0);
			
			return (account.balance || 0) + transactionsSum;
		}

		function calculateIncome(account) {
			return account.transactions
			  .filter(t => t.type === 'income' && isCurrentMonth(t.date))
			  .reduce((total, t) => total + t.amount, 0);
		}

		function calculateExpense(account) {
			return account.transactions
			  .filter(t => t.type === 'expense' && isCurrentMonth(t.date))
			  .reduce((total, t) => total + t.amount, 0);
		}

        // Add this function to calculate daily expenses
        function calculateDailyExpenses(account) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Start of today
            
            return account.transactions
                .filter(t => {
                    const transactionDate = new Date(Number(t.date));
                    transactionDate.setHours(0, 0, 0, 0);
                    return t.type === 'expense' && 
                           transactionDate.getTime() === today.getTime();
                })
                .reduce((total, t) => total + t.amount, 0);
        }

        function renderAccounts() {
            // Remove existing total account if it exists
            accounts = accounts.filter(a => !a.isTotal);
            
            // Add the total account
            accounts.push(createTotalAccount());
            
            const container = document.getElementById('accountsContainer');
            container.innerHTML = accounts.map(account => `
                <div class="account-card" draggable="${!account.isTotal}" data-account="${account.name}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 class="account-name" ${!account.isTotal ? 'onclick="startRenaming(\'' + account.name + '\')"' : ''}>${account.name}</h2>
                        ${!account.isTotal ? `
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <small style="color: #666; cursor: pointer;" onclick="startRenaming('${account.name}')">
                                    (click to rename)
                                </small>
                                <button class="delete-account-btn" onclick="deleteAccount('${account.name}')" 
                                        style="background: #e74c3c; color: white; border: none; padding: 2px 8px; border-radius: 3px;">
                                    ×
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <div class="balance">Balance: ${Math.abs(calculateBalance(account)) < 0.005 ? '0.00' : calculateBalance(account).toFixed(2)}</div>
                    <div class="income">Monthly income: ${calculateIncome(account).toFixed(2)}</div>
                    <div class="expense">Monthly expense: ${calculateExpense(account).toFixed(2)}</div>
                    <div class="daily-expense" style="color: #e74c3c; font-size: 1.2em; margin-top: 5px;">
                        Today's Expenses: ${calculateDailyExpenses(account).toFixed(2)}
                    </div>
                    
                    <button class="expand-button" onclick="toggleTransactions(this)">
                        Transactions (${account.transactions.length})
                    </button>
                    
                    <div class="transactions-container">
                        <div class="transactions-scroll">
						  ${account.transactions.length > 0 ? `
							${account.transactions
								.slice() // Create a copy of the array to avoid in-place sorting
								.sort((a, b) => b.date - a.date)
								.map(t => `
								  <div style="color: ${t.type === 'income' ? '#2ecc71' : '#e74c3c'}; 
											  margin: 5px 0; padding: 5px; border-left: 3px solid 
											  ${t.type === 'income' ? '#2ecc71' : '#e74c3c'}">
									  <div style="display: flex; justify-content: space-between; align-items: start;">
										  <div>
											  <strong>${t.type.toUpperCase()}</strong><br>
											  ${new Date(Number(t.date)).toLocaleString('en-US', {
												  year: 'numeric',
												  month: 'short',
												  day: 'numeric',
												  hour: '2-digit',
												  minute: '2-digit',
												  hour12: true
											  })} - ${t.description}<br>
											  ${t.amount.toFixed(2)}
											  ${t.category ? `<br><em>Category: ${t.category}</em>` : ''}
										  </div>
										  <div>
											  <button onclick="editTransaction('${account.name}', ${t.date})" 
													  style="background: #3498db; color: white; border: none; padding: 2px 8px; border-radius: 3px; margin-right: 5px;">
												  Edit
											  </button>
											  <button onclick="deleteTransaction('${account.name}', ${t.date})"
													  style="background: #e74c3c; color: white; border: none; padding: 2px 8px; border-radius: 3px;">
												  Delete
											  </button>
										  </div>
									  </div>
								  </div>
								`).join('')}
						  ` : '<div style="color: #666; padding: 5px;">No transactions yet</div>'}
						</div>
                    </div>
                </div>
            `).join('');

            setupDragAndDrop();
            updateCarousel();
        }

        function setupDragAndDrop() {
            const accountCards = document.querySelectorAll('.account-card');
            let draggedCard = null;

            accountCards.forEach(card => {
                if (card.dataset.account === 'Total') return; // Skip Total account

                // Drag start
                card.addEventListener('dragstart', (e) => {
                    draggedCard = card;
                    card.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', card.dataset.account);
                });

                // Drag end
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    accountCards.forEach(card => card.classList.remove('drag-over'));
                });

                // Drag over
                card.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (card !== draggedCard) {
                        card.classList.add('drag-over');
                    }
                });

                // Drag leave
                card.addEventListener('dragleave', () => {
                    card.classList.remove('drag-over');
                });

                // Drop
                card.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (card !== draggedCard) {
                        const draggedAccountName = e.dataTransfer.getData('text/plain');
                        const targetAccountName = card.dataset.account;
                        
                        // Find indices
                        const draggedIndex = accounts.findIndex(a => a.name === draggedAccountName);
                        const targetIndex = accounts.findIndex(a => a.name === targetAccountName);
                        
                        // Swap positions
                        [accounts[draggedIndex], accounts[targetIndex]] = 
                        [accounts[targetIndex], accounts[draggedIndex]];
                        
                        // Save new order and update UI
                        saveToStorage();
                        renderAccounts();
                    }
                });
            });

            // Add drop functionality to container for when dragging to empty space
            const container = document.getElementById('accountsContainer');
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (afterElement == null) {
                    container.appendChild(draggable);
                } else {
                    container.insertBefore(draggable, afterElement);
                }
            });

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                const cards = [...container.querySelectorAll('.account-card')];
                // Update accounts array to match new order and update order properties
                accounts = cards.map((card, index) => {
                    const account = accounts.find(a => a.name === card.dataset.account);
                    account.order = index;  // Update order property
                    return account;
                });
                saveToStorage();
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.account-card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function searchTransactions() {
			const searchTerm = document.getElementById('searchInput').value.toLowerCase();
			if (!searchTerm) {
				alert('Please enter a search term');
				return;
			}

			const results = [];

			// Search only non-Total accounts
			accounts
				.filter(account => !account.isTotal)
				.forEach(account => {
					account.transactions.forEach(transaction => {
						const formattedDate = new Date(Number(transaction.date)).toLocaleString('en-US', {
							year: 'numeric',
							month: 'short',
							day: 'numeric',
							hour: '2-digit',
							minute: '2-digit',
							hour12: true
						}).toLowerCase();

						if (
							transaction.description.toLowerCase().includes(searchTerm) || 
							(transaction.category && transaction.category.toLowerCase().includes(searchTerm)) ||
							transaction.amount.toString().includes(searchTerm) ||
							formattedDate.includes(searchTerm)
						) {
							results.push({
								account: account.name,
								...transaction,
								formattedDate: formattedDate
							});
						}
					});
				});

			// Sort results by date descending (most recent first)
			results.sort((a, b) => b.date - a.date);
			displaySearchResults(results, searchTerm);
		}

        function displaySearchResults(results, searchTerm) {
            const modal = document.getElementById('searchResultsModal');
            const resultsContainer = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<p>No matching transactions found.</p>';
            } else {
                resultsContainer.innerHTML = `
                    <p>Found ${results.length} matching transaction${results.length === 1 ? '' : 's'}</p>
                    ${results.map(result => `
                        <div class="search-result-item">
                            <strong>Account:</strong> ${result.account}<br>
                            <strong>Date:</strong> ${result.formattedDate}<br>
                            <strong>Type:</strong> ${result.type}<br>
                            <strong>Amount:</strong> ${result.amount.toFixed(2)}<br>
                            <strong>Category:</strong> ${result.category ? highlightText(result.category, searchTerm) : '—'}<br>
							<strong>Description:</strong> ${highlightText(result.description, searchTerm)}
                        </div>
                    `).join('')}
                `;
            }
            
            modal.style.display = 'block';
        }

        function highlightText(text, searchTerm) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function closeSearchModal() {
            document.getElementById('searchResultsModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
		
		// Get the search results modal element
		const searchResultsModal = document.getElementById('searchResultsModal');

		// When the user clicks anywhere on the backdrop (but not inside the content), close it
		searchResultsModal.addEventListener('click', function(e) {
			// e.target === this ensures clicks on the backdrop, not its children
			if (e.target === this) {
				closeSearchModal();
		}
		});

        // Add renaming functionality
        function startRenaming(accountName) {
            const accountCard = document.querySelector(`[data-account="${accountName}"]`);
            const nameElement = accountCard.querySelector('.account-name');
            const currentName = nameElement.textContent;
            
            // Create input element
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'rename-input';
            
            // Replace name with input
            nameElement.parentElement.replaceChild(input, nameElement);
            input.focus();
            
            // Handle input events
            input.addEventListener('blur', () => finishRenaming(input, currentName, accountCard));
            input.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    input.value = currentName;
                    input.blur();
                }
            });
        }

        function finishRenaming(input, oldName, accountCard) {
            const newName = input.value.trim();
            
            // Recreate the original elements
            const nameContainer = document.createElement('div');
            nameContainer.style = 'display: flex; justify-content: space-between; align-items: center;';
            
            const h2 = document.createElement('h2');
            h2.className = 'account-name';
            
            if (newName && newName !== oldName) {
                // Check if name already exists
                if (accounts.some(a => a.name === newName)) {
                    alert('An account with this name already exists!');
                    h2.textContent = oldName;
                    h2.onclick = () => startRenaming(oldName);
                } else {
                    // Update account name
                    const account = accounts.find(a => a.name === oldName);
                    account.name = newName;
                    h2.textContent = newName;
                    h2.onclick = () => startRenaming(newName);
                    accountCard.dataset.account = newName;
                    
                    // Update references in transfer transactions
                    accounts.forEach(acc => {
                        acc.transactions.forEach(trans => {
                            if (trans.description.includes(`to ${oldName}:`)) {
                                trans.description = trans.description.replace(`to ${oldName}:`, `to ${newName}:`);
                            }
                            if (trans.description.includes(`from ${oldName}:`)) {
                                trans.description = trans.description.replace(`from ${oldName}:`, `from ${newName}:`);
                            }
                        });
                    });
                    
                    saveToStorage();
                    updateAccountSelects();
                }
            } else {
                h2.textContent = oldName;
                h2.onclick = () => startRenaming(oldName);
            }
            
            const small = document.createElement('small');
            small.style = 'color: #666; cursor: pointer;';
            small.textContent = '(click to rename)';
            small.onclick = () => startRenaming(h2.textContent);
            
            nameContainer.appendChild(h2);
            nameContainer.appendChild(small);
            input.parentElement.replaceChild(nameContainer, input);
        }

        // Update the toggleTransactions function
        function toggleTransactions(button) {
            const container = button.nextElementSibling;
            container.classList.toggle('expanded');
            button.classList.toggle('expanded');
            
            // Prevent carousel swipe when transactions are expanded
            const carouselContainer = document.querySelector('.carousel-container');
            if (container.classList.contains('expanded')) {
                carouselContainer.style.pointerEvents = 'none';
                // Enable scrolling within transactions
                container.querySelector('.transactions-scroll').style.pointerEvents = 'auto';
            } else {
                carouselContainer.style.pointerEvents = 'auto';
            }
        }

        function moveCarousel(direction) {
            const totalSlides = accounts.length; // Include all accounts
            currentSlide = (currentSlide + direction + totalSlides) % totalSlides;
            updateCarousel();
        }

        function goToSlide(index) {
            currentSlide = index;
            updateCarousel();
        }

        function updateCarousel() {
            const wrapper = document.querySelector('#accountsContainer');
            if (!wrapper) return;
            
            const containerWidth = wrapper.parentElement.offsetWidth;
            
            // Use full position including Total account
            wrapper.style.transform = `translateX(${-currentSlide * containerWidth}px)`;
            
            // Show/hide navigation buttons
            const prevButton = document.querySelector('.carousel-button.prev');
            const nextButton = document.querySelector('.carousel-button.next');
            
            if (prevButton && nextButton) {
                prevButton.style.display = currentSlide === 0 ? 'none' : 'flex';
                nextButton.style.display = currentSlide === accounts.length - 1 ? 'none' : 'flex';
            }
            
            // Update indicators to include Total account
            const indicatorContainer = document.getElementById('carouselIndicator');
            indicatorContainer.innerHTML = accounts.map((_, index) => `
                <div class="indicator-dot ${index === currentSlide ? 'active' : ''}" 
                     onclick="goToSlide(${index})">
                </div>
            `).join('');

            // Update forms only if current account is not Total
            if (accounts[currentSlide] && !accounts[currentSlide].isTotal) {
                document.getElementById('incomeAccount').value = accounts[currentSlide].name;
                document.getElementById('expenseAccount').value = accounts[currentSlide].name;
            }
        }

        function updateFormsForCurrentAccount() {
            if (accounts.length > 0) {
                const currentAccount = accounts[currentSlide];
                document.getElementById('incomeAccount').value = currentAccount.name;
                document.getElementById('expenseAccount').value = currentAccount.name;
            }
        }

        // Update the touch event listeners
        document.querySelector('.carousel-container').addEventListener('touchstart', e => {
            // Don't prevent default on transaction container or expand button
            if (e.target.closest('.transactions-scroll') || e.target.closest('.expand-button')) {
                return;
            }
            
            const expandedTransactions = document.querySelector('.transactions-container.expanded');
            if (expandedTransactions && !e.target.closest('.transactions-scroll')) {
                e.preventDefault();
                return;
            }
            touchStartX = e.changedTouches[0].screenX;
        });

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // Swipe left
                    moveCarousel(1);
                } else {
                    // Swipe right
                    moveCarousel(-1);
                }
            }
        }

        // Add window resize handler
        window.addEventListener('resize', () => {
            updateCarousel();
        });

        // Add this function to create the total account
        function createTotalAccount() {
            let totalTransactions = [];
            
            accounts.forEach(account => {
                if (account.name !== 'Total') {
                    account.transactions.forEach(transaction => {
                        totalTransactions.push({
                            ...transaction,
                            description: `${account.name}: ${transaction.description}`,
                            date: Number(transaction.date) // Force numeric date
                        });
                    });
                }
            });

            // Sort by numeric date
            totalTransactions.sort((a, b) => b.date - a.date);

            return {
                name: 'Total',
                isTotal: true,
                transactions: totalTransactions,
                order: Infinity
            };
        }

        function deleteAccount(accountName) {
            if (accountName === 'Total') return;
            
            const confirmation = confirm(`Are you sure you want to delete account "${accountName}"?
This will permanently remove all its transactions!`);
            
            if (confirmation) {
                // Simply remove the account, preserve all transactions in other accounts
                accounts = accounts.filter(a => a.name !== accountName);
                
                saveToStorage();
                renderAccounts();
                alert(`Account "${accountName}" deleted successfully`);
            }
        }

        function editTransaction(accountName, transactionDate) {
            const account = accounts.find(a => a.name === accountName);
            const transaction = account.transactions.find(t => t.date === transactionDate);
            
            if (!transaction) return;
            
            // Populate edit form
            document.getElementById('editTransactionAccount').value = accountName;
            document.getElementById('editTransactionDate').value = transactionDate;
            document.getElementById('editTransactionAmount').value = transaction.amount;
            document.getElementById('editTransactionDescription').value = transaction.description;
            document.getElementById('editTransactionCategory').value = transaction.category || '';
			
            // Show modal
            document.getElementById('editTransactionModal').style.display = 'flex';
        }

        function hideEditModal() {
            document.getElementById('editTransactionModal').style.display = 'none';
        }

        function updateTransaction() {
            const accountName = document.getElementById('editTransactionAccount').value;
            const transactionDate = Number(document.getElementById('editTransactionDate').value);
            const amount = parseFloat(document.getElementById('editTransactionAmount').value);
            const description = document.getElementById('editTransactionDescription').value;
			const category = document.getElementById('editTransactionCategory').value;
            
            if (!amount || amount <= 0) return alert('Please enter a valid amount');
            if (!description) return alert('Please enter a description');
            
            const account = accounts.find(a => a.name === accountName);
            const transaction = account.transactions.find(t => t.date === transactionDate);
            
            if (!transaction) return;
            
            // Update transaction
            transaction.amount = amount;
            transaction.description = description;
			transaction.category = category.trim() || 'Uncategorized';
            
            // Save and refresh
            saveToStorage();
            renderAccounts();
            hideEditModal();
        }

        function deleteTransaction(accountName, transactionDate) {
            if (!confirm('Are you sure you want to delete this transaction?')) return;
            
            const account = accounts.find(a => a.name === accountName);
            account.transactions = account.transactions.filter(t => t.date !== transactionDate);
            
            saveToStorage();
            renderAccounts();
        }

        // Initialize IndexedDB when page loads
        initDB();
		    function setupAutoCategoryFill() {
        const mappings = [
            { descId: 'incomeDescription', catId: 'incomeCategory' },
            { descId: 'expenseDescription', catId: 'expenseCategory' },
            { descId: 'transferDescription', catId: 'transferCategory' }
        ];

		mappings.forEach(({ descId, catId }) => {
			const descInput = document.getElementById(descId);
			const catInput = document.getElementById(catId);

			// If either element is missing, skip this mapping (prevents runtime errors)
			if (!descInput || !catInput) {
				console.warn('Auto-category: missing element for', descId, catId);
				return;
			}

		descInput.addEventListener('blur', function () {
			const desc = this.value.trim().toLowerCase();
			if (!desc) return;

			const type = descId.startsWith('income') ? 'income' : 'expense';
			const key = `${type}|${desc}`;

			if (categoryMap[key] && !catInput.value.trim()) {
				catInput.value = categoryMap[key];
			}
		});
		});
    }

    setupAutoCategoryFill();
    </script>
</body>
</html> 