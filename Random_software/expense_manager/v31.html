<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --background: #f8fafc;
            --surface: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 12px;
            --radius-sm: 8px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* Account Cards */
        .accounts-section {
            padding: 1rem;
        }

        .carousel-container {
            position: relative;
            overflow: hidden;
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        .carousel-wrapper {
            display: flex;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .account-card {
            min-width: 100%;
            background: var(--surface);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .account-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .account-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: color 0.2s;
        }

        .account-name:hover {
            color: var(--primary-color);
        }

        .account-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .rename-hint {
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .delete-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .balance-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .balance-item {
            text-align: center;
            padding: 0.75rem;
            background: var(--background);
            border-radius: var(--radius-sm);
        }

        .balance-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .balance-value {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .balance-value.positive {
            color: var(--success-color);
        }

        .balance-value.negative {
            color: var(--danger-color);
        }

        .balance-value.neutral {
            color: var(--text-primary);
        }

        /* Transactions */
        .expand-button {
            background: none;
            border: none;
            width: 100%;
            padding: 0.75rem;
            background: var(--background);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .expand-button:hover {
            background: #f1f5f9;
        }

        .expand-button::after {
            transition: transform 0.3s;
            font-size: 0.875rem;
        }

        .expand-button.expanded::after {
            transform: rotate(180deg);
        }

        .transactions-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .transactions-container.expanded {
            max-height: 400px;
        }

        .transactions-scroll {
            max-height: 350px;
            overflow-y: auto;
            padding: 0.5rem 0;
        }

        .transaction-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .transaction-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }

        .transaction-item.income::before {
            background: var(--success-color);
        }

        .transaction-item.expense::before {
            background: var(--danger-color);
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .transaction-type {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .transaction-type.income {
            color: var(--success-color);
        }

        .transaction-type.expense {
            color: var(--danger-color);
        }

        .transaction-amount {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .transaction-details {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .transaction-category {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .transaction-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .transaction-btn {
            background: var(--info-color);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .transaction-btn.delete {
            background: var(--danger-color);
        }

        .transaction-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        /* Carousel Navigation */
        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .carousel-nav:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: translateY(-50%) scale(1.1);
        }

        .carousel-nav.prev {
            left: 10px;
        }

        .carousel-nav.next {
            right: 10px;
        }

        .carousel-indicators {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .indicator.active {
            background: var(--primary-color);
            transform: scale(1.2);
        }

        /* Import Export Section */
        .import-export-section {
            padding: 1rem;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .import-export-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .import-export-btn {
            background: var(--warning-color);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            text-align: center;
        }

        .import-export-btn:hover {
            background: #d97706;
            transform: translateY(-1px);
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            padding: 1rem;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .action-btn {
            padding: 1rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .action-btn:hover::before {
            left: 100%;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .action-btn.income {
            background: linear-gradient(135deg, var(--success-color), #059669);
        }

        .action-btn.expense {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
        }

        .action-btn.transfer {
            background: linear-gradient(135deg, var(--info-color), #2563eb);
        }

        .action-icon {
            font-size: 1.5rem;
        }

        /* Search Section */
        .search-section {
            padding: 1rem;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .search-container {
            display: flex;
            gap: 0.5rem;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            background: var(--background);
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .search-btn:hover {
            background: #7c3aed;
            transform: translateY(-1px);
        }

        /* Add Account Section */
        .add-account-section {
            padding: 1rem;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .add-account-container {
            display: flex;
            gap: 0.5rem;
        }

        .add-account-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            background: var(--background);
        }

        .add-account-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .add-account-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 1.5rem;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-modal:hover {
            background: var(--background);
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            background: var(--background);
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .submit-btn {
            width: 100%;
            padding: 0.875rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 0.5rem;
        }

        .submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* Search Results Modal */
        .search-results-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .search-results-content {
            background: var(--surface);
            margin: 2rem auto;
            padding: 1.5rem;
            width: 95%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            position: relative;
        }

        .search-result-item {
            background: var(--background);
            padding: 1rem;
            border-radius: var(--radius-sm);
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--primary-color);
        }

        .highlight {
            background: #fef08a;
            padding: 0.125rem 0.25rem;
            border-radius: 4px;
            font-weight: 600;
        }

        /* Rename Input */
        .rename-input {
            font-size: 1.25rem;
            font-weight: 600;
            padding: 0.5rem;
            border: 2px solid var(--primary-color);
            border-radius: var(--radius-sm);
            background: var(--surface);
            width: 100%;
            max-width: 200px;
        }

            /* Carousel indicator dots for account jumping */
            .indicator-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: var(--border);
                cursor: pointer;
                margin: 0 4px;
                display: inline-block;
                transition: background 0.2s, transform 0.2s;
            }
            .indicator-dot.active {
                background: var(--primary-color);
                transform: scale(1.2);
            }

        /* Responsive Design */
        @media (min-width: 768px) {
            .container {
                max-width: 768px;
                margin: 0 auto;
                padding: 0 1rem;
            }

            .header {
                border-radius: var(--radius) var(--radius) 0 0;
                margin-top: 1rem;
            }

            .action-buttons {
                position: static;
                border-radius: 0 0 var(--radius) var(--radius);
            }

            .balance-info {
                grid-template-columns: repeat(4, 1fr);
            }

            .carousel-nav {
                width: 48px;
                height: 48px;
            }
        }

        @media (min-width: 1024px) {
            .container {
                max-width: 1024px;
            }

            .accounts-section {
                padding: 2rem;
            }

            .account-card {
                padding: 2rem;
            }
        }

        /* Scrollbar Styling */
        .transactions-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .transactions-scroll::-webkit-scrollbar-track {
            background: var(--background);
            border-radius: 3px;
        }

        .transactions-scroll::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .transactions-scroll::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Touch Improvements */
        @media (hover: none) {
            .action-btn:hover,
            .transaction-btn:hover,
            .carousel-nav:hover {
                transform: none;
            }
        }

        /* Dark mode support (optional) */
        @media (prefers-color-scheme: dark) {
            :root {
                --background: #0f172a;
                --surface: #1e293b;
                --text-primary: #f1f5f9;
                --text-secondary: #94a3b8;
                --border: #334155;
            }
        }
		
		/* Allow pointer events to reach the expand button */
		.account-card .expand-button {
			pointer-events: auto;
			position: relative;
			z-index: 5;
		}

		/* Ensure the button is reachable even inside the swipe wrapper */
		.carousel-wrapper {
			pointer-events: none;
		}
		.carousel-wrapper .account-card {
			pointer-events: auto;
		}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üí∞ Expense Manager</h1>
        </div>

        <!-- Accounts Section -->
        <div class="accounts-section">
            <div class="carousel-container">
                <button class="carousel-nav prev" onclick="moveCarousel(-1)">‚ùÆ</button>
                <button class="carousel-nav next" onclick="moveCarousel(1)">‚ùØ</button>
                <div class="carousel-wrapper" id="accountsContainer"></div>
            </div>
            <div class="carousel-indicators" id="carouselIndicator"></div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="action-btn income" onclick="showForm('income')">
                <span class="action-icon">üí∞</span>
                <span>Income</span>
            </button>
            <button class="action-btn expense" onclick="showForm('expense')">
                <span class="action-icon">üí∏</span>
                <span>Expense</span>
            </button>
            <button class="action-btn transfer" onclick="showForm('transfer')">
                <span class="action-icon">üîÑ</span>
                <span>Transfer</span>
            </button>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Search transactions...">
                <button class="search-btn" onclick="searchTransactions()">
                    üîç Search
                </button>
            </div>
        </div>

        <!-- Add Account Section -->
        <div class="add-account-section">
            <div class="add-account-container">
                <input type="text" id="newAccountName" class="add-account-input" placeholder="New account name">
                <button class="add-account-btn" onclick="addAccount()">
                    ‚ûï Add Account
                </button>
            </div>
        </div>

        <!-- Import Export Section -->
        <div class="import-export-section">
            <div class="import-export-container">
                <input type="file" id="importFile" style="display: none;" accept=".json">
                <button class="import-export-btn" onclick="document.getElementById('importFile').click()">
                    üì• Import Transactions
                </button>
                <button class="import-export-btn" onclick="exportData()">
                    üì§ Export Transactions
                </button>
                <input type="file" id="importCategoriesFile" style="display: none;" accept=".json">
                <button class="import-export-btn" onclick="document.getElementById('importCategoriesFile').click()">
                    üìã Import Categories
                </button>
                <button class="import-export-btn" onclick="exportCategories()">
                    üìã Export Categories
                </button>
            </div>
        </div>
    </div>

    <!-- Income Modal -->
    <div id="incomeForm" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí∞ Add Income</h2>
                <button class="close-modal" onclick="hideForm('income')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Account</label>
                <select id="incomeAccount" class="form-select"></select>
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" id="incomeAmount" class="form-input" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" id="incomeDescription" class="form-input" placeholder="What is this income for?">
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <input type="text" id="incomeCategory" class="form-input" placeholder="e.g., Salary, Freelance">
            </div>
            <button class="submit-btn" onclick="addIncome()">Add Income</button>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseForm" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí∏ Add Expense</h2>
                <button class="close-modal" onclick="hideForm('expense')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Account</label>
                <select id="expenseAccount" class="form-select"></select>
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" id="expenseAmount" class="form-input" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" id="expenseDescription" class="form-input" placeholder="What did you spend on?">
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <input type="text" id="expenseCategory" class="form-input" placeholder="e.g., Food, Transport">
            </div>
            <button class="submit-btn" onclick="addExpense()">Add Expense</button>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div id="transferForm" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üîÑ Transfer Funds</h2>
                <button class="close-modal" onclick="hideForm('transfer')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">From Account</label>
                <select id="fromAccount" class="form-select"></select>
            </div>
            <div class="form-group">
                <label class="form-label">To Account</label>
                <select id="toAccount" class="form-select"></select>
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" id="transferAmount" class="form-input" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" id="transferDescription" class="form-input" placeholder="Transfer reason">
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <input type="text" id="transferCategory" class="form-input" placeholder="e.g., Savings, Investment">
            </div>
            <button class="submit-btn" onclick="transferFunds()">Transfer Funds</button>
        </div>
    </div>

    <!-- Search Results Modal -->
    <div id="searchResultsModal" class="search-results-modal">
        <div class="search-results-content">
            <div class="modal-header">
                <h2 class="modal-title">üîç Search Results</h2>
                <button class="close-modal" onclick="closeSearchModal()">&times;</button>
            </div>
            <div id="searchResults"></div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è Edit Transaction</h2>
                <button class="close-modal" onclick="hideEditModal()">&times;</button>
            </div>
            <input type="hidden" id="editTransactionAccount">
            <input type="hidden" id="editTransactionDate">
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" id="editTransactionAmount" class="form-input" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" id="editTransactionDescription" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <input type="text" id="editTransactionCategory" class="form-input">
            </div>
            <button class="submit-btn" onclick="saveEditedTransaction()">Save Changes</button>
        </div>
    </div>

    <script>
        let accounts = [];
        let db;
        let currentSlide = 0;
		let categoryMap = {};

        // Initialize IndexedDB
		const initDB = () => {
			// Bump version to 2 to trigger onupgradeneeded for old DBs
			const request = indexedDB.open('ExpenseManagerDB', 3);

			request.onerror = (event) => {
				console.error('Database error:', event.target.error);
			};

			request.onupgradeneeded = (event) => {
				const db = event.target.result;

				// Create accounts store if missing
				if (!db.objectStoreNames.contains('accounts')) {
					db.createObjectStore('accounts', { keyPath: 'name' });
				}

				// Create categoryMap store if missing
				if (!db.objectStoreNames.contains('categoryMap')) {
					db.createObjectStore('categoryMap');
				}
			};

			request.onsuccess = (event) => {
				db = event.target.result;

				// Load accounts into memory
				loadFromStorage();

				// Only try to read categoryMap if it exists (avoids crash on old DBs)
				if (db.objectStoreNames.contains('categoryMap')) {
					const catTransaction = db.transaction(['categoryMap'], 'readonly');
					const catStore = catTransaction.objectStore('categoryMap');
					const catRequest = catStore.get('map');

					catRequest.onsuccess = () => {
						if (catRequest.result) {
							categoryMap = catRequest.result;
						} else {
							categoryMap = {};
						}
					};

					catRequest.onerror = () => {
						console.error('Error reading categoryMap from DB');
						categoryMap = {};
					};
				} else {
					categoryMap = {};
				}
			};
		};

        // Load accounts from IndexedDB
        function loadFromStorage() {
            const transaction = db.transaction(['accounts'], 'readwrite');
            const store = transaction.objectStore('accounts');
            const request = store.getAll();

            request.onsuccess = () => {
                accounts = request.result;
                
                // Convert all dates to timestamps
                accounts.forEach(account => {
                    account.transactions.forEach(transaction => {
                        if (typeof transaction.date !== 'number') {
                            transaction.date = new Date(transaction.date).getTime() || Date.now();
                        }
                    });
                });
                
                // Save converted data back
                const putTransaction = db.transaction(['accounts'], 'readwrite');
                const putStore = putTransaction.objectStore('accounts');
                accounts.forEach(account => putStore.put(account));
                
                accounts.sort((a, b) => (a.order || 0) - (b.order || 0));
                updateAccountSelects();
                renderAccounts();
            };
        }

        // Save accounts to IndexedDB
		function saveToStorage() {
			let storeNames = ['accounts'];
			if (db.objectStoreNames.contains('categoryMap')) {
				storeNames.push('categoryMap');
			}
			const transaction = db.transaction(storeNames, 'readwrite');

			// Save accounts
			const store = transaction.objectStore('accounts');
			store.clear();
			accounts.forEach(account => {
				store.add(account);
			});

			// Save category map
			if (db.objectStoreNames.contains('categoryMap')) {
				const catStore = transaction.objectStore('categoryMap');
				catStore.put(categoryMap, 'map');
			}
		}

        // Maintain transaction limit
		function maintainTransactionLimit(account) {
			const MAX_TRANSACTIONS = 500;
			// Ensure transactions are in chronological order (oldest first)
			account.transactions.sort((a, b) => a.date - b.date);
			while (account.transactions.length > MAX_TRANSACTIONS) {
				const removedTransaction = account.transactions.shift(); // removes oldest transaction
				// Roll its effect into the stored balance
				account.balance = (account.balance || 0) + 
					(removedTransaction.type === 'income' ? removedTransaction.amount : -removedTransaction.amount);
			}
		}
		
		function isCurrentMonth(timestamp) {
			const now = new Date();
			const date = new Date(timestamp);
			return date.getFullYear() === now.getFullYear() && date.getMonth() === now.getMonth();
		}

        // Export accounts to JSON file
        function exportData() {
            const dataToExport = accounts
                .filter(account => !account.isTotal) // Exclude Total account
                .map(account => ({
                    ...account,
                    transactions: account.transactions.map(transaction => ({
                        ...transaction,
                        date: Number(transaction.date), // Ensure date is numeric
						timestamp: new Date(Number(transaction.date)).toLocaleString('en-GB', {
							day: '2-digit',
							month: '2-digit',
							year: 'numeric',
							hour: '2-digit',
							minute: '2-digit',
							hour12: true
						}).replace(',', ' :')
                    }))
                }));

            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expense-manager-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
		

        // Import accounts from JSON file
		document.getElementById('importFile').addEventListener('change', function(e) {
			const file = e.target.files[0];
			if (!file) return;

			const reader = new FileReader();
			reader.onload = function(e) {
				try {
					const importedData = JSON.parse(e.target.result);
					
					// Validate imported data
					if (!Array.isArray(importedData)) throw new Error('Invalid file format');
					
					// Process imported accounts
					const newAccounts = importedData.map(account => {
						// Ensure each account has a balance property (default to 0 if not present)
						let a = {
							...account,
							balance: account.balance !== undefined ? account.balance : 0,
							transactions: account.transactions.map(t => ({
								type: t.type,
								amount: parseFloat(t.amount),
								description: t.description,
								category: t.category || '',
								date: t.date ? Number(t.date) : Date.now() // Handle legacy data
							}))
						};
						// Apply the transaction limit so that older transactions are trimmed
						maintainTransactionLimit(a);
						return a;
					});
					
					// Clear existing accounts (except the Total account)
					accounts = [createTotalAccount()];
					
					// Add imported accounts
					newAccounts.forEach(account => {
						if (!account.name || account.isTotal) return; // Skip invalid entries
						accounts.unshift(account);
					});

					// Save and refresh
					saveToStorage();
					renderAccounts();
					alert('Successfully imported ' + newAccounts.length + ' accounts!');
					
				} catch (error) {
					alert('Error importing data: ' + error.message);
				}
			};
			reader.readAsText(file);
		});
		
        function exportCategories() {
            if (Object.keys(categoryMap).length === 0) {
                alert('There are no categories to export.');
                return;
            }

            const blob = new Blob([JSON.stringify(categoryMap, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expense-manager-categories-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ADD THIS EVENT LISTENER BLOCK
        document.getElementById('importCategoriesFile').addEventListener('change', function(e) {
			const file = e.target.files[0];
			if (!file) return;

			const reader = new FileReader();
			reader.onload = function(e) {
				try {
					const importedCategories = JSON.parse(e.target.result);
					
                    // Basic validation to ensure it's an object
					if (typeof importedCategories !== 'object' || Array.isArray(importedCategories)) {
                        throw new Error('Invalid categories file format.');
                    }
					
                    // Merge with existing categories, overwriting duplicates
                    categoryMap = { ...categoryMap, ...importedCategories };

					saveToStorage(); // This will save the updated categoryMap to IndexedDB
					alert('Successfully imported and merged categories!');
					
				} catch (error) {
					alert('Error importing categories: ' + error.message);
				}
			};
			reader.readAsText(file);
		});		

        function showForm(formType) {
            // Hide all forms first
            document.getElementById('incomeForm').style.display = 'none';
            document.getElementById('expenseForm').style.display = 'none';
            document.getElementById('transferForm').style.display = 'none';
            
            // Show requested form
            const form = document.getElementById(formType + 'Form');
            form.style.display = 'flex';
            
            // Clear previous values
            form.querySelector('input[type="number"]').value = '';
            form.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
            
            // Focus on amount field
            form.querySelector('input[type="number"]').focus();
        }

        function hideForm(formType) {
            document.getElementById(formType + 'Form').style.display = 'none';
        }

        function updateAccountSelects() {
            const accountSelects = document.querySelectorAll('select[id$="Account"]');
            accountSelects.forEach(select => {
                select.innerHTML = accounts
                    .filter(a => !a.isTotal) // Exclude Total account
                    .map(a => `<option value="${a.name}">${a.name}</option>`)
                    .join('');
            });
        }

		function addAccount() {
			const accountName = document.getElementById('newAccountName').value;
			if (!accountName) return alert('Please enter an account name');
			
		    const positionInput = parseInt(prompt(
		 	 `Enter insertion position (0 to ${accounts.length}):`
		    ), 10);
		    const pos = Number.isInteger(positionInput)
		 	 ? Math.min(Math.max(positionInput, 0), accounts.length)
		 	 : accounts.length;

		    const newAccount = {
			  name: accountName,
			  transactions: [],
			  balance: 0,    // rolling‚Äìbalance
			  order: pos     // temporary; will be overwritten below
		    };
		    // insert the new account object at index `pos`
		    accounts.splice(pos, 0, newAccount);

  		    // re-assign every account‚Äôs order to its index
		    accounts.forEach((acct, idx) => {
			  acct.order = idx;
		    });
							
			saveToStorage();
			updateAccountSelects();
			renderAccounts();
			document.getElementById('newAccountName').value = '';
		}

        function addIncome() {
            if (accounts.length === 0) {
                alert('Please create an account first');
                return;
            }

            const account = accounts[currentSlide];
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const description = document.getElementById('incomeDescription').value;

            if (!amount || amount <= 0) return alert('Please enter a valid amount');
			const incomeCategory = document.getElementById('incomeCategory').value.trim() || 'Uncategorized';
            account.transactions.push({
                type: 'income',
                amount,
                description,
				category: incomeCategory,
                date: Date.now() // Use timestamp in milliseconds
            });
			
			
			categoryMap[`income|${description.trim().toLowerCase()}`] = incomeCategory;
			
            maintainTransactionLimit(account);
            saveToStorage();
            renderAccounts();
            hideForm('income');
        }

        function addExpense() {
            if (accounts.length === 0) {
                alert('Please create an account first');
                return;
            }

            const account = accounts[currentSlide];
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const description = document.getElementById('expenseDescription').value;

            if (!amount || amount <= 0) return alert('Please enter a valid amount');
		
			const expenseCategory = document.getElementById('expenseCategory').value.trim() || 'Uncategorized';
			
            account.transactions.push({
                type: 'expense',
                amount,
                description,
				category: expenseCategory,
                date: Date.now() // Use timestamp in milliseconds
            });
			
			
			categoryMap[`expense|${description.trim().toLowerCase()}`] = expenseCategory;

            maintainTransactionLimit(account);
            saveToStorage();
            renderAccounts();
            hideForm('expense');
        }

        function transferFunds() {
            const fromAccount = document.getElementById('fromAccount').value;
            const toAccount = document.getElementById('toAccount').value;
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const description = document.getElementById('transferDescription').value;

            // Validate inputs
            if (!fromAccount || !toAccount) {
                alert('Please select both accounts');
                return;
            }
            if (fromAccount === toAccount) {
                alert('Cannot transfer between the same account');
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            // Check if either account is Total
            if (fromAccount === 'Total' || toAccount === 'Total') {
                alert('Cannot transfer to/from the Total account');
                return;
            }

            const source = accounts.find(a => a.name === fromAccount);
            const target = accounts.find(a => a.name === toAccount);

            // Check if source has enough balance with 0.01 tolerance
            const sourceBalance = calculateBalance(source);
            if (sourceBalance < (amount - 0.0001)) { // Allow for floating point precision errors
                alert(`Insufficient funds. Available balance: ${sourceBalance.toFixed(2)}`);
                return;
            }

            // Use exact amount from input
            const preciseAmount = parseFloat(amount.toFixed(2));
            
            const timestamp = Date.now();
            
            // Update transactions to use precise amounts
            source.transactions.push({
                type: 'expense',
                amount: preciseAmount,
                description: `Transfer to ${toAccount}: ${description}`,
				category: document.getElementById('transferCategory').value.trim() || 'Uncategorized',
                date: timestamp
            });
            
            target.transactions.push({
                type: 'income',
                amount: preciseAmount,
                description: `Transfer from ${fromAccount}: ${description}`,
				category: document.getElementById('transferCategory').value.trim() || 'Uncategorized',
                date: timestamp
            });

            // Maintain transaction limits
            maintainTransactionLimit(source);
            maintainTransactionLimit(target);

            // Clear form fields
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferDescription').value = '';

            // Save and update UI
            saveToStorage();
            renderAccounts();
            hideForm('transfer');
        }

		function calculateBalance(account) {
			const transactionsSum = account.transactions.reduce((total, t) => {
				return t.type === 'income' ? total + t.amount : total - t.amount;
			}, 0);
			
			return (account.balance || 0) + transactionsSum;
		}

		function calculateIncome(account) {
			return account.transactions
			  .filter(t => t.type === 'income' && isCurrentMonth(t.date))
			  .reduce((total, t) => total + t.amount, 0);
		}

		function calculateExpense(account) {
			return account.transactions
			  .filter(t => t.type === 'expense' && isCurrentMonth(t.date))
			  .reduce((total, t) => total + t.amount, 0);
		}

        // Add this function to calculate daily expenses
        function calculateDailyExpenses(account) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Start of today
            
            return account.transactions
                .filter(t => {
                    const transactionDate = new Date(Number(t.date));
                    transactionDate.setHours(0, 0, 0, 0);
                    return t.type === 'expense' && 
                           transactionDate.getTime() === today.getTime();
                })
                .reduce((total, t) => total + t.amount, 0);
        }

        function renderAccounts() {
            // Remove existing total account if it exists
            accounts = accounts.filter(a => !a.isTotal);
            
            // Add the total account
            accounts.push(createTotalAccount());
            
            const container = document.getElementById('accountsContainer');
            container.innerHTML = accounts.map(account => `
                <div class="account-card" draggable="${!account.isTotal}" data-account="${account.name}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 class="account-name" ${!account.isTotal ? 'onclick="startRenaming(\'' + account.name + '\')"' : ''}>${account.name}</h2>
                        ${!account.isTotal ? `
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <small style="color: #666; cursor: pointer;" onclick="startRenaming('${account.name}')">
                                    (click to rename)
                                </small>
                                <button class="delete-account-btn" onclick="deleteAccount('${account.name}')" 
                                        style="background: #e74c3c; color: white; border: none; padding: 2px 8px; border-radius: 3px;">
                                    √ó
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <div class="balance">Balance: ${Math.abs(calculateBalance(account)) < 0.005 ? '0.00' : calculateBalance(account).toFixed(2)}</div>
                    <div class="income">Monthly income: ${calculateIncome(account).toFixed(2)}</div>
                    <div class="expense">Monthly expense: ${calculateExpense(account).toFixed(2)}</div>
                    <div class="daily-expense" style="color: #e74c3c; font-size: 1.2em; margin-top: 5px;">
                        Today's Expenses: ${calculateDailyExpenses(account).toFixed(2)}
                    </div>
                    
                    <button class="expand-button" onclick="toggleTransactions(this)">
                        Transactions (${account.transactions.length})
                    </button>
                    
                    <div class="transactions-container">
                        <div class="transactions-scroll">
						  ${account.transactions.length > 0 ? `
							${account.transactions
								.slice() // Create a copy of the array to avoid in-place sorting
								.sort((a, b) => b.date - a.date)
								.map(t => `
								  <div style="color: ${t.type === 'income' ? '#2ecc71' : '#e74c3c'}; 
											  margin: 5px 0; padding: 5px; border-left: 3px solid 
											  ${t.type === 'income' ? '#2ecc71' : '#e74c3c'}">
									  <div style="display: flex; justify-content: space-between; align-items: start;">
										  <div>
											  <strong>${t.type.toUpperCase()}</strong><br>
											  ${new Date(Number(t.date)).toLocaleString('en-US', {
												  year: 'numeric',
												  month: 'short',
												  day: 'numeric',
												  hour: '2-digit',
												  minute: '2-digit',
												  hour12: true
											  })} - ${t.description}<br>
											  ${t.amount.toFixed(2)}
											  ${t.category ? `<br><em>Category: ${t.category}</em>` : ''}
										  </div>
										  <div>
											  <button onclick="editTransaction('${account.name}', ${t.date})" 
													  style="background: #3498db; color: white; border: none; padding: 2px 8px; border-radius: 3px; margin-right: 5px;">
												  Edit
											  </button>
											  <button onclick="deleteTransaction('${account.name}', ${t.date})"
													  style="background: #e74c3c; color: white; border: none; padding: 2px 8px; border-radius: 3px;">
												  Delete
											  </button>
										  </div>
									  </div>
								  </div>
								`).join('')}
						  ` : '<div style="color: #666; padding: 5px;">No transactions yet</div>'}
						</div>
                    </div>
                </div>
            `).join('');

            setupDragAndDrop();
            updateCarousel();
        }

        function setupDragAndDrop() {
            const accountCards = document.querySelectorAll('.account-card');
            let draggedCard = null;

            accountCards.forEach(card => {
                if (card.dataset.account === 'Total') return; // Skip Total account

                // Drag start
                card.addEventListener('dragstart', (e) => {
                    draggedCard = card;
                    card.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', card.dataset.account);
                });

                // Drag end
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    accountCards.forEach(card => card.classList.remove('drag-over'));
                });

                // Drag over
                card.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (card !== draggedCard) {
                        card.classList.add('drag-over');
                    }
                });

                // Drag leave
                card.addEventListener('dragleave', () => {
                    card.classList.remove('drag-over');
                });

                // Drop
                card.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (card !== draggedCard) {
                        const draggedAccountName = e.dataTransfer.getData('text/plain');
                        const targetAccountName = card.dataset.account;
                        
                        // Find indices
                        const draggedIndex = accounts.findIndex(a => a.name === draggedAccountName);
                        const targetIndex = accounts.findIndex(a => a.name === targetAccountName);
                        
                        // Swap positions
                        [accounts[draggedIndex], accounts[targetIndex]] = 
                        [accounts[targetIndex], accounts[draggedIndex]];
                        
                        // Save new order and update UI
                        saveToStorage();
                        renderAccounts();
                    }
                });
            });

            // Add drop functionality to container for when dragging to empty space
            const container = document.getElementById('accountsContainer');
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (afterElement == null) {
                    container.appendChild(draggable);
                } else {
                    container.insertBefore(draggable, afterElement);
                }
            });

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                const cards = [...container.querySelectorAll('.account-card')];
                // Update accounts array to match new order and update order properties
                accounts = cards.map((card, index) => {
                    const account = accounts.find(a => a.name === card.dataset.account);
                    account.order = index;  // Update order property
                    return account;
                });
                saveToStorage();
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.account-card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function searchTransactions() {
			const searchTerm = document.getElementById('searchInput').value.toLowerCase();
			if (!searchTerm) {
				alert('Please enter a search term');
				return;
			}

			const results = [];

			// Search only non-Total accounts
			accounts
				.filter(account => !account.isTotal)
				.forEach(account => {
					account.transactions.forEach(transaction => {
						const formattedDate = new Date(Number(transaction.date)).toLocaleString('en-US', {
							year: 'numeric',
							month: 'short',
							day: 'numeric',
							hour: '2-digit',
							minute: '2-digit',
							hour12: true
						}).toLowerCase();

						if (
							transaction.description.toLowerCase().includes(searchTerm) || 
							(transaction.category && transaction.category.toLowerCase().includes(searchTerm)) ||
							transaction.amount.toString().includes(searchTerm) ||
							formattedDate.includes(searchTerm)
						) {
							results.push({
								account: account.name,
								...transaction,
								formattedDate: formattedDate
							});
						}
					});
				});

			// Sort results by date descending (most recent first)
			results.sort((a, b) => b.date - a.date);
			displaySearchResults(results, searchTerm);
		}

        function displaySearchResults(results, searchTerm) {
            const modal = document.getElementById('searchResultsModal');
            const resultsContainer = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<p>No matching transactions found.</p>';
            } else {
                resultsContainer.innerHTML = `
                    <p>Found ${results.length} matching transaction${results.length === 1 ? '' : 's'}</p>
                    ${results.map(result => `
                        <div class="search-result-item">
                            <strong>Account:</strong> ${result.account}<br>
                            <strong>Date:</strong> ${result.formattedDate}<br>
                            <strong>Type:</strong> ${result.type}<br>
                            <strong>Amount:</strong> ${result.amount.toFixed(2)}<br>
                            <strong>Category:</strong> ${result.category ? highlightText(result.category, searchTerm) : '‚Äî'}<br>
							<strong>Description:</strong> ${highlightText(result.description, searchTerm)}
                        </div>
                    `).join('')}
                `;
            }
            
            modal.style.display = 'block';
        }

        function highlightText(text, searchTerm) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function closeSearchModal() {
            document.getElementById('searchResultsModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
		
		// Get the search results modal element
		const searchResultsModal = document.getElementById('searchResultsModal');

		// When the user clicks anywhere on the backdrop (but not inside the content), close it
		searchResultsModal.addEventListener('click', function(e) {
			// e.target === this ensures clicks on the backdrop, not its children
			if (e.target === this) {
				closeSearchModal();
		}
		});

        // Add renaming functionality
        function startRenaming(accountName) {
            const accountCard = document.querySelector(`[data-account="${accountName}"]`);
            const nameElement = accountCard.querySelector('.account-name');
            const currentName = nameElement.textContent;
            
            // Create input element
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'rename-input';
            
            // Replace name with input
            nameElement.parentElement.replaceChild(input, nameElement);
            input.focus();
            
            // Handle input events
            input.addEventListener('blur', () => finishRenaming(input, currentName, accountCard));
            input.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    input.value = currentName;
                    input.blur();
                }
            });
        }

        function finishRenaming(input, oldName, accountCard) {
            const newName = input.value.trim();
            
            // Recreate the original elements
            const nameContainer = document.createElement('div');
            nameContainer.style = 'display: flex; justify-content: space-between; align-items: center;';
            
            const h2 = document.createElement('h2');
            h2.className = 'account-name';
            
            if (newName && newName !== oldName) {
                // Check if name already exists
                if (accounts.some(a => a.name === newName)) {
                    alert('An account with this name already exists!');
                    h2.textContent = oldName;
                    h2.onclick = () => startRenaming(oldName);
                } else {
                    // Update account name
                    const account = accounts.find(a => a.name === oldName);
                    account.name = newName;
                    h2.textContent = newName;
                    h2.onclick = () => startRenaming(newName);
                    accountCard.dataset.account = newName;
                    
                    // Update references in transfer transactions
                    accounts.forEach(acc => {
                        acc.transactions.forEach(trans => {
                            if (trans.description.includes(`to ${oldName}:`)) {
                                trans.description = trans.description.replace(`to ${oldName}:`, `to ${newName}:`);
                            }
                            if (trans.description.includes(`from ${oldName}:`)) {
                                trans.description = trans.description.replace(`from ${oldName}:`, `from ${newName}:`);
                            }
                        });
                    });
                    
                    saveToStorage();
                    updateAccountSelects();
                }
            } else {
                h2.textContent = oldName;
                h2.onclick = () => startRenaming(oldName);
            }
            
            const small = document.createElement('small');
            small.style = 'color: #666; cursor: pointer;';
            small.textContent = '(click to rename)';
            small.onclick = () => startRenaming(h2.textContent);
            
            nameContainer.appendChild(h2);
            nameContainer.appendChild(small);
            input.parentElement.replaceChild(nameContainer, input);
        }

        // Update the toggleTransactions function
        function toggleTransactions(button) {
            const container = button.nextElementSibling;
            container.classList.toggle('expanded');
            button.classList.toggle('expanded');
            
            // Prevent carousel swipe when transactions are expanded
            const carouselContainer = document.querySelector('.carousel-container');
            if (container.classList.contains('expanded')) {
                carouselContainer.style.pointerEvents = 'none';
                // Enable scrolling within transactions
                container.querySelector('.transactions-scroll').style.pointerEvents = 'auto';
            } else {
                carouselContainer.style.pointerEvents = 'auto';
            }
        }

        function moveCarousel(direction) {
            const totalSlides = accounts.length; // Include all accounts
            currentSlide = (currentSlide + direction + totalSlides) % totalSlides;
            updateCarousel();
        }

        function goToSlide(index) {
            currentSlide = index;
            updateCarousel();
        }

        function updateCarousel() {
            const wrapper = document.querySelector('#accountsContainer');
            if (!wrapper) return;
            
            const containerWidth = wrapper.parentElement.offsetWidth;
            
            // Use full position including Total account
            wrapper.style.transform = `translateX(${-currentSlide * containerWidth}px)`;
            
            // Show/hide navigation buttons
            const prevButton = document.querySelector('.carousel-button.prev');
            const nextButton = document.querySelector('.carousel-button.next');
            
            if (prevButton && nextButton) {
                prevButton.style.display = currentSlide === 0 ? 'none' : 'flex';
                nextButton.style.display = currentSlide === accounts.length - 1 ? 'none' : 'flex';
            }
            
            // Update indicators to include Total account
            const indicatorContainer = document.getElementById('carouselIndicator');
            indicatorContainer.innerHTML = accounts.map((_, index) => `
                <div class="indicator-dot ${index === currentSlide ? 'active' : ''}" 
                     onclick="goToSlide(${index})">
                </div>
            `).join('');

            // Update forms only if current account is not Total
            if (accounts[currentSlide] && !accounts[currentSlide].isTotal) {
                document.getElementById('incomeAccount').value = accounts[currentSlide].name;
                document.getElementById('expenseAccount').value = accounts[currentSlide].name;
            }
        }

        function updateFormsForCurrentAccount() {
            if (accounts.length > 0) {
                const currentAccount = accounts[currentSlide];
                document.getElementById('incomeAccount').value = currentAccount.name;
                document.getElementById('expenseAccount').value = currentAccount.name;
            }
        }

        // Update the touch event listeners
        document.querySelector('.carousel-container').addEventListener('touchstart', e => {
            // Don't prevent default on transaction container or expand button
            if (e.target.closest('.transactions-scroll') || e.target.closest('.expand-button')) {
                return;
            }
            
            const expandedTransactions = document.querySelector('.transactions-container.expanded');
            if (expandedTransactions && !e.target.closest('.transactions-scroll')) {
                e.preventDefault();
                return;
            }
            touchStartX = e.changedTouches[0].screenX;
        });

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // Swipe left
                    moveCarousel(1);
                } else {
                    // Swipe right
                    moveCarousel(-1);
                }
            }
        }

        // Add window resize handler
        window.addEventListener('resize', () => {
            updateCarousel();
        });

        // Add this function to create the total account
        function createTotalAccount() {
            let totalTransactions = [];
            
            accounts.forEach(account => {
                if (account.name !== 'Total') {
                    account.transactions.forEach(transaction => {
                        totalTransactions.push({
                            ...transaction,
                            description: `${account.name}: ${transaction.description}`,
                            date: Number(transaction.date) // Force numeric date
                        });
                    });
                }
            });

            // Sort by numeric date
            totalTransactions.sort((a, b) => b.date - a.date);

            return {
                name: 'Total',
                isTotal: true,
                transactions: totalTransactions,
                order: Infinity
            };
        }

        function deleteAccount(accountName) {
            if (accountName === 'Total') return;
            
            const confirmation = confirm(`Are you sure you want to delete account "${accountName}"?
This will permanently remove all its transactions!`);
            
            if (confirmation) {
                // Simply remove the account, preserve all transactions in other accounts
                accounts = accounts.filter(a => a.name !== accountName);
                
                saveToStorage();
                renderAccounts();
                alert(`Account "${accountName}" deleted successfully`);
            }
        }

        function editTransaction(accountName, transactionDate) {
            const account = accounts.find(a => a.name === accountName);
            const transaction = account.transactions.find(t => t.date === transactionDate);
            
            if (!transaction) return;
            
            // Populate edit form
            document.getElementById('editTransactionAccount').value = accountName;
            document.getElementById('editTransactionDate').value = transactionDate;
            document.getElementById('editTransactionAmount').value = transaction.amount;
            document.getElementById('editTransactionDescription').value = transaction.description;
            document.getElementById('editTransactionCategory').value = transaction.category || '';
			
            // Show modal
            document.getElementById('editTransactionModal').style.display = 'flex';
        }

        function hideEditModal() {
            document.getElementById('editTransactionModal').style.display = 'none';
        }

        function updateTransaction() {
            const accountName = document.getElementById('editTransactionAccount').value;
            const transactionDate = Number(document.getElementById('editTransactionDate').value);
            const amount = parseFloat(document.getElementById('editTransactionAmount').value);
            const description = document.getElementById('editTransactionDescription').value;
			const category = document.getElementById('editTransactionCategory').value;
            
            if (!amount || amount <= 0) return alert('Please enter a valid amount');
            if (!description) return alert('Please enter a description');
            
            const account = accounts.find(a => a.name === accountName);
            const transaction = account.transactions.find(t => t.date === transactionDate);
            
            if (!transaction) return;
            
            // Update transaction
            transaction.amount = amount;
            transaction.description = description;
			transaction.category = category.trim() || 'Uncategorized';
            
            // Save and refresh
            saveToStorage();
            renderAccounts();
            hideEditModal();
        }

        function deleteTransaction(accountName, transactionDate) {
            if (!confirm('Are you sure you want to delete this transaction?')) return;
            
            const account = accounts.find(a => a.name === accountName);
            account.transactions = account.transactions.filter(t => t.date !== transactionDate);
            
            saveToStorage();
            renderAccounts();
        }

        // Initialize IndexedDB when page loads
        initDB();
		    function setupAutoCategoryFill() {
        const mappings = [
            { descId: 'incomeDescription', catId: 'incomeCategory' },
            { descId: 'expenseDescription', catId: 'expenseCategory' },
            { descId: 'transferDescription', catId: 'transferCategory' }
        ];

		mappings.forEach(({ descId, catId }) => {
			const descInput = document.getElementById(descId);
			const catInput = document.getElementById(catId);

			// If either element is missing, skip this mapping (prevents runtime errors)
			if (!descInput || !catInput) {
				console.warn('Auto-category: missing element for', descId, catId);
				return;
			}

		descInput.addEventListener('blur', function () {
			const desc = this.value.trim().toLowerCase();
			if (!desc) return;

			const type = descId.startsWith('income') ? 'income' : 'expense';
			const key = `${type}|${desc}`;

			if (categoryMap[key] && !catInput.value.trim()) {
				catInput.value = categoryMap[key];
			}
		});
		});
    }

    setupAutoCategoryFill();
    </script>
</body>
</html>