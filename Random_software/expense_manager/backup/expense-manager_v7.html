<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Manager</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .nav-button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .income-btn {
            background-color: #2ecc71;
            color: white;
        }
        .expense-btn {
            background-color: #e74c3c;
            color: white;
        }
        .transfer-btn {
            background-color: #3498db;
            color: white;
        }
        .form-section {
            display: none;
        }
        .form-section.active {
            display: block;
        }
        .account-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 300px;
            display: inline-block;
            vertical-align: top;
            cursor: move;
            user-select: none;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .account-card.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .account-card.drag-over {
            border: 2px dashed #3498db;
        }
        #accountsContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 10px;
            min-height: 100px;
        }
        .transaction-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        input, select {
            margin: 5px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: calc(100% - 26px);
        }
        button {
            margin: 5px;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .submit-btn {
            background-color: #4CAF50;
            color: white;
            width: 100%;
            padding: 12px;
            margin-top: 15px;
        }
        .balance {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .income {
            color: #2ecc71;
        }
        .expense {
            color: #e74c3c;
        }
        .search-container {
            margin: 20px 0;
        }
        
        .search-input {
            width: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-right: 10px;
        }
        
        .search-results-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .search-results-content {
            position: relative;
            background-color: white;
            margin: 50px auto;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .close-search {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin: 5px 0;
        }
        
        .search-result-item:hover {
            background-color: #f5f5f5;
        }
        
        .highlight {
            background-color: yellow;
            padding: 2px;
        }
        
        .account-name {
            cursor: pointer;
        }
        
        .account-name:hover {
            color: #3498db;
        }

        .rename-input {
            font-size: 1.5em;
            padding: 5px;
            margin: 5px 0;
            width: 80%;
        }

        .transactions-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .transactions-container.expanded {
            max-height: 400px;
            overflow-y: auto;
        }

        .expand-button {
            background: none;
            border: none;
            color: #666;
            padding: 5px 10px;
            margin: 10px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            width: 100%;
            justify-content: space-between;
        }

        .expand-button:hover {
            background-color: #f5f5f5;
        }

        .expand-button::after {
            content: '▼';
            font-size: 12px;
            transition: transform 0.3s;
        }

        .expand-button.expanded::after {
            transform: rotate(180deg);
        }

        .transactions-scroll {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        /* Custom scrollbar styling */
        .transactions-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .transactions-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .transactions-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .transactions-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .carousel-container {
            position: relative;
            width: 90%;
            max-width: 800px;
            min-width: 320px;
            margin: 0 auto;
            overflow: hidden;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 0;
        }

        .carousel-wrapper {
            display: flex;
            transition: transform 0.3s ease-in-out;
            width: 100%;
        }

        .account-card {
            width: 100%;
            min-width: 100%;
            margin: 0;
            padding: 20px;
            flex: 0 0 100%;
            box-sizing: border-box;
        }

        #accountsContainer {
            display: flex;
            transition: transform 0.3s ease-in-out;
            gap: 0;
            padding: 0;
            flex-wrap: nowrap;
        }

        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 40px;
            height: 50px;
            cursor: pointer;
            z-index: 10;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .carousel-button.prev {
            left: 0;
        }

        .carousel-button.next {
            right: 0;
        }

        .carousel-indicator {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            gap: 5px;
        }

        .indicator-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
            cursor: pointer;
        }

        .indicator-dot.active {
            background: #3498db;
        }

        /* Hide account selects in income/expense forms */
        #incomeForm select, #expenseForm select {
            display: none;
        }

        .balance, .income, .expense {
            font-size: 1.5em;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Expense Manager</h1>
        
        <div class="file-buttons" style="margin-bottom: 20px;">
            <button class="nav-button" onclick="importAccounts()" style="background-color: #9b59b6; color: white; margin-right: 10px;">Import from JSON</button>
            <button class="nav-button" onclick="exportAccounts()" style="background-color: #9b59b6; color: white;">Export to JSON</button>
        </div>

        <div class="search-container">
            <input type="text" 
                   class="search-input" 
                   id="searchInput" 
                   placeholder="Search transactions..."
                   onkeyup="if(event.key === 'Enter') searchTransactions()">
            <button class="nav-button" 
                    onclick="searchTransactions()" 
                    style="background-color: #34495e; color: white;">
                Search
            </button>
        </div>

        <div class="transaction-form">
            <h2>Add New Account</h2>
            <input type="text" id="accountName" placeholder="Account name">
            <button class="submit-btn" onclick="addAccount()">Create Account</button>
        </div>

        <div class="nav-buttons">
            <button class="nav-button income-btn" onclick="showForm('income')">Income</button>
            <button class="nav-button expense-btn" onclick="showForm('expense')">Expense</button>
            <button class="nav-button transfer-btn" onclick="showForm('transfer')">Transfer</button>
        </div>

        <div id="incomeForm" class="form-section transaction-form">
            <h2>Add Income</h2>
            <select id="incomeAccount">
                <!-- Accounts will be populated dynamically -->
            </select>
            <input type="number" id="incomeAmount" placeholder="Amount">
            <input type="text" id="incomeDescription" placeholder="Description">
            <button class="submit-btn" onclick="addIncome()">Add Income</button>
        </div>

        <div id="expenseForm" class="form-section transaction-form">
            <h2>Add Expense</h2>
            <select id="expenseAccount">
                <!-- Accounts will be populated dynamically -->
            </select>
            <input type="number" id="expenseAmount" placeholder="Amount">
            <input type="text" id="expenseDescription" placeholder="Description">
            <button class="submit-btn" onclick="addExpense()">Add Expense</button>
        </div>

        <div id="transferForm" class="form-section transaction-form">
            <h2>Transfer Between Accounts</h2>
            <select id="fromAccount"></select>
            <select id="toAccount"></select>
            <input type="number" id="transferAmount" placeholder="Amount">
            <input type="text" id="transferDescription" placeholder="Description">
            <button class="submit-btn" onclick="transferFunds()">Transfer</button>
        </div>

        <div class="carousel-container">
            <button class="carousel-button prev" onclick="moveCarousel(-1)">❮</button>
            <button class="carousel-button next" onclick="moveCarousel(1)">❯</button>
            <div class="carousel-wrapper" id="accountsContainer">
                <!-- Accounts will be rendered here -->
            </div>
        </div>
        <div class="carousel-indicator" id="carouselIndicator">
            <!-- Indicators will be added here -->
        </div>
    </div>

    <div id="searchResultsModal" class="search-results-modal">
        <div class="search-results-content">
            <span class="close-search" onclick="closeSearchModal()">&times;</span>
            <h2>Search Results</h2>
            <div id="searchResults"></div>
        </div>
    </div>

    <script>
        let accounts = [];
        let db;
        let currentSlide = 0;

        // Initialize IndexedDB
        const initDB = () => {
            const request = indexedDB.open('ExpenseManagerDB', 1);

            request.onerror = (event) => {
                console.error('Database error:', event.target.error);
            };

            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('accounts')) {
                    db.createObjectStore('accounts', { keyPath: 'name' });
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                loadFromStorage();
            };
        };

        // Load accounts from IndexedDB
        function loadFromStorage() {
            const transaction = db.transaction(['accounts'], 'readonly');
            const store = transaction.objectStore('accounts');
            const request = store.getAll();

            request.onsuccess = () => {
                accounts = request.result;
                // Sort by order property instead of name
                accounts.sort((a, b) => (a.order || 0) - (b.order || 0));
                updateAccountSelects();
                renderAccounts();
            };
        }

        // Save accounts to IndexedDB
        function saveToStorage() {
            const transaction = db.transaction(['accounts'], 'readwrite');
            const store = transaction.objectStore('accounts');

            // Clear existing data
            store.clear();

            // Add each account
            accounts.forEach(account => {
                store.add(account);
            });
        }

        // Maintain transaction limit
        function maintainTransactionLimit(account) {
            const TRANSACTION_LIMIT = 1000;
            if (account.transactions.length > TRANSACTION_LIMIT) {
                // Remove oldest transactions to maintain limit
                const excess = account.transactions.length - TRANSACTION_LIMIT;
                account.transactions.splice(0, excess);
            }
        }

        // Export accounts to JSON file
        function exportAccounts() {
            if (accounts.length === 0) {
                alert('No accounts to export!');
                return;
            }
            
            // Create a deep copy of the accounts to export
            const accountsToExport = JSON.parse(JSON.stringify(accounts));
            const data = JSON.stringify(accountsToExport, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `expense-manager-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Import accounts from JSON file
        function importAccounts() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedAccounts = JSON.parse(e.target.result);
                        
                        // Validate the imported data structure
                        if (!Array.isArray(importedAccounts)) {
                            throw new Error('Invalid data format: Expected an array of accounts');
                        }
                        
                        // Validate each account has required properties
                        importedAccounts.forEach(account => {
                            if (!account.name || !Array.isArray(account.transactions)) {
                                throw new Error('Invalid account format');
                            }
                        });
                        
                        // Update accounts array
                        accounts = importedAccounts;
                        
                        // Check and maintain transaction limits for all accounts
                        accounts.forEach(account => maintainTransactionLimit(account));
                        
                        // Save to IndexedDB
                        saveToStorage();
                        
                        // Update UI
                        updateAccountSelects();
                        renderAccounts();
                        
                        alert('Accounts imported successfully!');
                    } catch (error) {
                        console.error('Error importing file:', error);
                        alert('Error importing file. Please make sure it\'s a valid expense manager JSON file.');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function showForm(formType) {
            document.querySelectorAll('.form-section').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(`${formType}Form`).classList.add('active');
        }

        function updateAccountSelects() {
            const selects = document.querySelectorAll('select');
            selects.forEach(select => {
                select.innerHTML = accounts.map(account => 
                    `<option value="${account.name}">${account.name}</option>`
                ).join('');
            });
        }

        function addAccount() {
            const accountName = document.getElementById('accountName').value;
            if (!accountName) return alert('Please enter an account name');
            
            const newAccount = {
                name: accountName,
                transactions: [],
                order: accounts.length  // Add order property
            };
            
            accounts.push(newAccount);
            saveToStorage();
            updateAccountSelects();
            renderAccounts();
            document.getElementById('accountName').value = '';
        }

        function addIncome() {
            if (accounts.length === 0) {
                alert('Please create an account first');
                return;
            }

            const account = accounts[currentSlide];
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const description = document.getElementById('incomeDescription').value;

            if (!amount || amount <= 0) return alert('Please enter a valid amount');

            account.transactions.push({
                type: 'income',
                amount,
                description,
                date: new Date().toLocaleString()
            });

            maintainTransactionLimit(account);
            saveToStorage();
            renderAccounts();
            document.getElementById('incomeAmount').value = '';
            document.getElementById('incomeDescription').value = '';
        }

        function addExpense() {
            if (accounts.length === 0) {
                alert('Please create an account first');
                return;
            }

            const account = accounts[currentSlide];
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const description = document.getElementById('expenseDescription').value;

            if (!amount || amount <= 0) return alert('Please enter a valid amount');

            account.transactions.push({
                type: 'expense',
                amount,
                description,
                date: new Date().toLocaleString()
            });

            maintainTransactionLimit(account);
            saveToStorage();
            renderAccounts();
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseDescription').value = '';
        }

        function transferFunds() {
            const fromAccount = document.getElementById('fromAccount').value;
            const toAccount = document.getElementById('toAccount').value;
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const description = document.getElementById('transferDescription').value;

            if (fromAccount === toAccount) return alert('Cannot transfer to same account');
            if (!amount || amount <= 0) return alert('Please enter a valid amount');
            
            const source = accounts.find(a => a.name === fromAccount);
            const target = accounts.find(a => a.name === toAccount);
            const sourceBalance = calculateBalance(source);
            
            if (sourceBalance < amount) return alert('Insufficient funds');
            
            source.transactions.push({
                type: 'expense',
                amount,
                description: `Transfer to ${toAccount}: ${description}`,
                date: new Date().toLocaleString()
            });
            
            target.transactions.push({
                type: 'income',
                amount,
                description: `Transfer from ${fromAccount}: ${description}`,
                date: new Date().toLocaleString()
            });

            maintainTransactionLimit(source);
            maintainTransactionLimit(target);
            saveToStorage();
            renderAccounts();
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferDescription').value = '';
        }

        function calculateBalance(account) {
            return account.transactions.reduce((total, t) => 
                t.type === 'income' ? total + t.amount : total - t.amount, 0);
        }

        function calculateIncome(account) {
            return account.transactions.filter(t => t.type === 'income')
                .reduce((total, t) => total + t.amount, 0);
        }

        function calculateExpense(account) {
            return account.transactions.filter(t => t.type === 'expense')
                .reduce((total, t) => total + t.amount, 0);
        }

        function renderAccounts() {
            // Remove existing total account if it exists
            accounts = accounts.filter(a => !a.isTotal);
            
            // Add the total account
            accounts.push(createTotalAccount());
            
            const container = document.getElementById('accountsContainer');
            container.innerHTML = accounts.map(account => `
                <div class="account-card" draggable="${!account.isTotal}" data-account="${account.name}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 class="account-name" ${!account.isTotal ? 'onclick="startRenaming(\'' + account.name + '\')"' : ''}>${account.name}</h2>
                        ${!account.isTotal ? '<small style="color: #666; cursor: pointer;" onclick="startRenaming(\'' + account.name + '\')">(click to rename)</small>' : ''}
                    </div>
                    <div class="balance">Balance: ${calculateBalance(account).toFixed(2)}</div>
                    <div class="income">Income: ${calculateIncome(account).toFixed(2)}</div>
                    <div class="expense">Expense: ${calculateExpense(account).toFixed(2)}</div>
                    
                    <button class="expand-button" onclick="toggleTransactions(this)">
                        Transactions (${account.transactions.length})
                    </button>
                    
                    <div class="transactions-container">
                        <div class="transactions-scroll">
                            ${account.transactions.map(t => `
                                <div style="color: ${t.type === 'income' ? '#2ecc71' : '#e74c3c'}; 
                                    margin: 5px 0; padding: 5px; border-left: 3px solid 
                                    ${t.type === 'income' ? '#2ecc71' : '#e74c3c'}">
                                    ${t.date} - ${t.description}<br>
                                    ${t.amount.toFixed(2)} (${t.type})
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');

            setupDragAndDrop();
            updateCarousel();
        }

        function setupDragAndDrop() {
            const accountCards = document.querySelectorAll('.account-card');
            let draggedCard = null;

            accountCards.forEach(card => {
                if (card.dataset.account === 'Total') return; // Skip Total account

                // Drag start
                card.addEventListener('dragstart', (e) => {
                    draggedCard = card;
                    card.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', card.dataset.account);
                });

                // Drag end
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    accountCards.forEach(card => card.classList.remove('drag-over'));
                });

                // Drag over
                card.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (card !== draggedCard) {
                        card.classList.add('drag-over');
                    }
                });

                // Drag leave
                card.addEventListener('dragleave', () => {
                    card.classList.remove('drag-over');
                });

                // Drop
                card.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (card !== draggedCard) {
                        const draggedAccountName = e.dataTransfer.getData('text/plain');
                        const targetAccountName = card.dataset.account;
                        
                        // Find indices
                        const draggedIndex = accounts.findIndex(a => a.name === draggedAccountName);
                        const targetIndex = accounts.findIndex(a => a.name === targetAccountName);
                        
                        // Swap positions
                        [accounts[draggedIndex], accounts[targetIndex]] = 
                        [accounts[targetIndex], accounts[draggedIndex]];
                        
                        // Save new order and update UI
                        saveToStorage();
                        renderAccounts();
                    }
                });
            });

            // Add drop functionality to container for when dragging to empty space
            const container = document.getElementById('accountsContainer');
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (afterElement == null) {
                    container.appendChild(draggable);
                } else {
                    container.insertBefore(draggable, afterElement);
                }
            });

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                const cards = [...container.querySelectorAll('.account-card')];
                // Update accounts array to match new order and update order properties
                accounts = cards.map((card, index) => {
                    const account = accounts.find(a => a.name === card.dataset.account);
                    account.order = index;  // Update order property
                    return account;
                });
                saveToStorage();
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.account-card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function searchTransactions() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (!searchTerm) {
                alert('Please enter a search term');
                return;
            }

            const results = [];
            
            accounts.forEach(account => {
                account.transactions.forEach(transaction => {
                    if (transaction.description.toLowerCase().includes(searchTerm) || 
                        transaction.amount.toString().includes(searchTerm) ||
                        transaction.date.toLowerCase().includes(searchTerm)) {
                        results.push({
                            account: account.name,
                            ...transaction
                        });
                    }
                });
            });

            displaySearchResults(results, searchTerm);
        }

        function displaySearchResults(results, searchTerm) {
            const modal = document.getElementById('searchResultsModal');
            const resultsContainer = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<p>No matching transactions found.</p>';
            } else {
                resultsContainer.innerHTML = `
                    <p>Found ${results.length} matching transaction${results.length === 1 ? '' : 's'}</p>
                    ${results.map(result => `
                        <div class="search-result-item">
                            <strong>Account:</strong> ${result.account}<br>
                            <strong>Date:</strong> ${result.date}<br>
                            <strong>Type:</strong> ${result.type}<br>
                            <strong>Amount:</strong> ${result.amount.toFixed(2)}<br>
                            <strong>Description:</strong> ${highlightText(result.description, searchTerm)}
                        </div>
                    `).join('')}
                `;
            }
            
            modal.style.display = 'block';
        }

        function highlightText(text, searchTerm) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function closeSearchModal() {
            document.getElementById('searchResultsModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('searchResultsModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Add renaming functionality
        function startRenaming(accountName) {
            const accountCard = document.querySelector(`[data-account="${accountName}"]`);
            const nameElement = accountCard.querySelector('.account-name');
            const currentName = nameElement.textContent;
            
            // Create input element
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'rename-input';
            
            // Replace name with input
            nameElement.parentElement.replaceChild(input, nameElement);
            input.focus();
            
            // Handle input events
            input.addEventListener('blur', () => finishRenaming(input, currentName, accountCard));
            input.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    input.value = currentName;
                    input.blur();
                }
            });
        }

        function finishRenaming(input, oldName, accountCard) {
            const newName = input.value.trim();
            
            // Recreate the original elements
            const nameContainer = document.createElement('div');
            nameContainer.style = 'display: flex; justify-content: space-between; align-items: center;';
            
            const h2 = document.createElement('h2');
            h2.className = 'account-name';
            
            if (newName && newName !== oldName) {
                // Check if name already exists
                if (accounts.some(a => a.name === newName)) {
                    alert('An account with this name already exists!');
                    h2.textContent = oldName;
                    h2.onclick = () => startRenaming(oldName);
                } else {
                    // Update account name
                    const account = accounts.find(a => a.name === oldName);
                    account.name = newName;
                    h2.textContent = newName;
                    h2.onclick = () => startRenaming(newName);
                    accountCard.dataset.account = newName;
                    
                    // Update references in transfer transactions
                    accounts.forEach(acc => {
                        acc.transactions.forEach(trans => {
                            if (trans.description.includes(`to ${oldName}:`)) {
                                trans.description = trans.description.replace(`to ${oldName}:`, `to ${newName}:`);
                            }
                            if (trans.description.includes(`from ${oldName}:`)) {
                                trans.description = trans.description.replace(`from ${oldName}:`, `from ${newName}:`);
                            }
                        });
                    });
                    
                    saveToStorage();
                    updateAccountSelects();
                }
            } else {
                h2.textContent = oldName;
                h2.onclick = () => startRenaming(oldName);
            }
            
            const small = document.createElement('small');
            small.style = 'color: #666; cursor: pointer;';
            small.textContent = '(click to rename)';
            small.onclick = () => startRenaming(h2.textContent);
            
            nameContainer.appendChild(h2);
            nameContainer.appendChild(small);
            input.parentElement.replaceChild(nameContainer, input);
        }

        // Add new function to handle expanding/collapsing
        function toggleTransactions(button) {
            const container = button.nextElementSibling;
            const isExpanded = container.classList.toggle('expanded');
            button.classList.toggle('expanded');
        }

        function moveCarousel(direction) {
            const totalSlides = accounts.length; // Include all accounts
            currentSlide = (currentSlide + direction + totalSlides) % totalSlides;
            updateCarousel();
        }

        function goToSlide(index) {
            currentSlide = index;
            updateCarousel();
        }

        function updateCarousel() {
            const wrapper = document.querySelector('#accountsContainer');
            if (!wrapper) return;
            
            const containerWidth = wrapper.parentElement.offsetWidth;
            
            // Use full position including Total account
            wrapper.style.transform = `translateX(${-currentSlide * containerWidth}px)`;
            
            // Show/hide navigation buttons
            const prevButton = document.querySelector('.carousel-button.prev');
            const nextButton = document.querySelector('.carousel-button.next');
            
            if (prevButton && nextButton) {
                prevButton.style.display = currentSlide === 0 ? 'none' : 'flex';
                nextButton.style.display = currentSlide === accounts.length - 1 ? 'none' : 'flex';
            }
            
            // Update indicators to include Total account
            const indicatorContainer = document.getElementById('carouselIndicator');
            indicatorContainer.innerHTML = accounts.map((_, index) => `
                <div class="indicator-dot ${index === currentSlide ? 'active' : ''}" 
                     onclick="goToSlide(${index})">
                </div>
            `).join('');

            // Update forms only if current account is not Total
            if (accounts[currentSlide] && !accounts[currentSlide].isTotal) {
                document.getElementById('incomeAccount').value = accounts[currentSlide].name;
                document.getElementById('expenseAccount').value = accounts[currentSlide].name;
            }
        }

        function updateFormsForCurrentAccount() {
            if (accounts.length > 0) {
                const currentAccount = accounts[currentSlide];
                document.getElementById('incomeAccount').value = currentAccount.name;
                document.getElementById('expenseAccount').value = currentAccount.name;
            }
        }

        // Add touch support for mobile devices
        let touchStartX = 0;
        let touchEndX = 0;

        document.querySelector('.carousel-container').addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.querySelector('.carousel-container').addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // Swipe left
                    moveCarousel(1);
                } else {
                    // Swipe right
                    moveCarousel(-1);
                }
            }
        }

        // Add window resize handler
        window.addEventListener('resize', () => {
            updateCarousel();
        });

        // Add this function to create the total account
        function createTotalAccount() {
            let totalIncome = 0;
            let totalExpense = 0;
            let totalTransactions = [];
            
            // Calculate totals from all accounts except the Total account
            accounts.forEach(account => {
                if (account.name !== 'Total') {
                    account.transactions.forEach(transaction => {
                        if (transaction.type === 'income') {
                            totalIncome += transaction.amount;
                            totalTransactions.push({
                                ...transaction,
                                description: `${account.name}: ${transaction.description}`
                            });
                        } else if (transaction.type === 'expense') {
                            totalExpense += transaction.amount;
                            totalTransactions.push({
                                ...transaction,
                                description: `${account.name}: ${transaction.description}`
                            });
                        }
                    });
                }
            });

            return {
                name: 'Total',
                isTotal: true, // Flag to identify this as the total account
                transactions: totalTransactions,
                order: Infinity // Always keep it last
            };
        }

        // Initialize IndexedDB when page loads
        initDB();
    </script>
</body>
</html> 