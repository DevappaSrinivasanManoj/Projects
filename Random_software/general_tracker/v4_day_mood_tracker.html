<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day Mood Tracker</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: #fff;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 90%;
            max-width: 550px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 20px;
            letter-spacing: 1.5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .main-action {
            text-align: center;
            margin-bottom: 25px;
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        .action-btn {
            padding: 15px 30px;
            border-radius: 50px;
            border: none;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .good-btn {
            background: linear-gradient(90deg, #16a085, #27ae60);
            color: #fff;
        }
        .good-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .bad-btn {
            background: linear-gradient(90deg, #c0392b, #e74c3c);
            color: #fff;
        }
        .bad-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .streak {
            margin: 25px 0;
            font-size: 1.8em;
            text-align: center;
            color: #f1c40f;
            font-weight: bold;
        }
        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }
        .file-label, .export-btn {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .file-label:hover, .export-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        input[type="file"] { display: none; }
        #heatmap { margin: 30px 0; display: flex; justify-content: center; }
        .collapsible {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            cursor: pointer;
            padding: 12px 20px;
            width: 100%;
            border: none;
            border-radius: 8px;
            text-align: left;
            outline: none;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 20px;
        }
        .collapsible-content {
            padding: 15px;
            display: none;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 0 0 8px 8px;
        }
        .history-list {
            list-style: none; padding: 0; margin: 0;
            max-height: 250px; overflow-y: auto;
        }
        .history-list li {
            background: rgba(255,255,255,0.05);
            margin-bottom: 8px;
            padding: 12px;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Day Mood Tracker</h1>
        <div class="main-action">
            <button class="action-btn bad-btn" id="badBtn">Day was Bad</button>
            <button class="action-btn good-btn" id="goodBtn">Day was Good</button>
        </div>
        <div class="streak" id="streak"></div>
        <div id="heatmap"></div>
        <div class="actions">
            <button class="export-btn" id="exportBtn">Export Data</button>
            <label for="importFile" class="file-label">Import Data</label>
            <input type="file" id="importFile" accept=".json">
        </div>
        <button class="collapsible" id="toggleHistory">+ View History</button>
        <div class="collapsible-content" id="historyContent">
            <ul class="history-list" id="historyList"></ul>
        </div>
    </div>

    <script>
    // ----- CONFIGURATION -----
    const DB_NAME = "day_mood_tracker_db_v1";
    const STORE_NAME = 'moods';
    const DB_VERSION = 1;
    const STREAK_KEY = `${DB_NAME}_streak`;
    const HISTORY_LIMIT_DAYS = 90;
    const MOOD_GOOD = 'good';
    const MOOD_BAD = 'bad';
    const MOOD_NEUTRAL = 'neutral';
    let db;

    function getTodayISO() {
        const d = new Date();
        return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
    }

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = e => e.target.result.createObjectStore(STORE_NAME, { keyPath: 'date' });
            request.onsuccess = e => { db = e.target.result; resolve(db); };
            request.onerror = e => reject(e);
        });
    }

    function getStore(mode) {
        return db.transaction(STORE_NAME, mode).objectStore(STORE_NAME);
    }

    async function setMoodForToday(mood) {
        await openDB();
        const today = getTodayISO();
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).put({ date: today, mood });
        await tx.complete;
        await trimOldRecords();
        updateUI();
    }

    async function trimOldRecords() {
        await openDB();
        const store = getStore('readwrite');
        const records = await new Promise(r => store.getAll().onsuccess = e => r(e.target.result));
        if (records.length > HISTORY_LIMIT_DAYS) {
            records.sort((a, b) => new Date(a.date) - new Date(b.date));
            const recordsToDelete = records.slice(0, records.length - HISTORY_LIMIT_DAYS);
            for (const rec of recordsToDelete) {
                await new Promise(r => getStore('readwrite').delete(rec.date).onsuccess = r);
            }
        }
    }

    function getAllMoods() {
        return new Promise(async (resolve) => {
            await openDB();
            const request = getStore('readonly').getAll();
            request.onsuccess = e => resolve(e.target.result.sort((a, b) => new Date(b.date) - new Date(a.date)));
        });
    }

    function getMoodMap(records) {
        const map = {};
        for (const rec of records) map[rec.date] = rec.mood;
        return map;
    }

    function getPastDates(limit) {
        const arr = [];
        const today = new Date(getTodayISO());
        for (let i = 0; i < limit; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() - i);
            arr.push(d.toISOString().slice(0, 10));
        }
        return arr.reverse();
    }

    async function updateUI() {
        const records = await getAllMoods();
        const moodMap = getMoodMap(records);
        // Fill in neutral for missing days
        const allDates = getPastDates(HISTORY_LIMIT_DAYS);
        for (const date of allDates) {
            if (!moodMap[date] && new Date(date) < new Date(getTodayISO())) {
                moodMap[date] = MOOD_NEUTRAL;
            }
        }
        updateHistoryList(moodMap);
        updateStreak(moodMap);
        renderHeatmap(moodMap);
    }

    function updateHistoryList(moodMap) {
        const list = document.getElementById('historyList');
        const keys = Object.keys(moodMap).sort((a,b)=>b.localeCompare(a));
        list.innerHTML = keys.map(date => {
            let mood = moodMap[date];
            let moodText = mood === MOOD_GOOD ? 'Good' : mood === MOOD_BAD ? 'Bad' : 'Neutral';
            let color = mood === MOOD_GOOD ? '#27ae60' : mood === MOOD_BAD ? '#e74c3c' : '#ffa500';
            return `<li><span style="display:inline-block;width:14px;height:14px;border-radius:50%;background:${color};margin-right:10px;"></span>${new Date(date + 'T00:00:00').toLocaleDateString()} - ${moodText}</li>`;
        }).join('');
    }

    function updateStreak(moodMap) {
        const streakEl = document.getElementById('streak');
        const allDates = getPastDates(HISTORY_LIMIT_DAYS).reverse();
        let streak = 0;
        for (let i = allDates.length - 1; i >= 0; i--) {
            const mood = moodMap[allDates[i]];
            if (mood === MOOD_GOOD) {
                streak++;
            } else if (mood === MOOD_BAD || mood === MOOD_NEUTRAL) {
                break;
            }
        }
        localStorage.setItem(STREAK_KEY, JSON.stringify({ count: streak }));
        if (streak > 0) {
            streakEl.textContent = `Current Good Streak: ${streak} day${streak !== 1 ? 's' : ''}`;
        } else {
            streakEl.textContent = 'No current good streak.';
        }
    }

    function renderHeatmap(moodMap) {
        const heatmap = document.getElementById('heatmap');
        const allDates = getPastDates(HISTORY_LIMIT_DAYS);
        let html = '<table style="border-spacing:3px; margin:auto;">';
        for (let i = 0; i < 7; i++) {
            html += '<tr>';
            for (let j = 0; j < Math.ceil(HISTORY_LIMIT_DAYS / 7); j++) {
                const idx = j * 7 + i;
                if (idx >= allDates.length) continue;
                const date = allDates[idx];
                let mood = moodMap[date];
                let color = 'rgba(255,255,255,0.1)';
                if (mood === MOOD_GOOD) color = '#27ae60';
                else if (mood === MOOD_BAD) color = '#e74c3c';
                else if (mood === MOOD_NEUTRAL) color = '#ffa500';
                html += `<td title="${date}" style="width:20px;height:20px;border-radius:4px;background:${color};"></td>`;
            }
            html += '</tr>';
        }
        html += '</table>';
        heatmap.innerHTML = html;
    }

    document.getElementById('goodBtn').addEventListener('click', () => setMoodForToday(MOOD_GOOD));
    document.getElementById('badBtn').addEventListener('click', () => setMoodForToday(MOOD_BAD));

    document.getElementById('exportBtn').addEventListener('click', async () => {
        const records = await getAllMoods();
        const streakData = localStorage.getItem(STREAK_KEY);
        const data = {
            config: { DB_NAME },
            streak: JSON.parse(streakData),
            records
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${DB_NAME}_backup.json`;
        a.click();
        URL.revokeObjectURL(url);
    });

    document.getElementById('importFile').addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
            try {
                const data = JSON.parse(ev.target.result);
                if (!data.records || !data.config || data.config.DB_NAME !== DB_NAME) {
                    alert(`Import failed! This file is not for this tracker.`);
                    return;
                }
                if (data.streak) {
                    localStorage.setItem(STREAK_KEY, JSON.stringify(data.streak));
                }
                await openDB();
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.clear();
                for (const rec of data.records) {
                    store.put(rec);
                }
                tx.oncomplete = updateUI;
            } catch (err) {
                alert("Import failed. Invalid file format.");
            }
        };
        reader.readAsText(file);
    });

    const histBtn = document.getElementById('toggleHistory');
    const histContent = document.getElementById('historyContent');
    histBtn.addEventListener('click', () => {
        const isVisible = histContent.style.display === 'block';
        histContent.style.display = isVisible ? 'none' : 'block';
        histBtn.textContent = (isVisible ? '+' : '-') + " View History";
    });

    // On page load, fill in neutral for previous days if not set
    openDB().then(async () => {
        const records = await getAllMoods();
        const moodMap = getMoodMap(records);
        const allDates = getPastDates(HISTORY_LIMIT_DAYS);
        let changed = false;
        for (const date of allDates) {
            if (!moodMap[date] && new Date(date) < new Date(getTodayISO())) { // Check if date is in the past
                await setMoodForTodayOnDate(date, MOOD_NEUTRAL);
                changed = true;
            }
        }
        if (changed) { updateUI(); } else { updateUI(); } // Always update UI on load
    });

    async function setMoodForTodayOnDate(date, mood) {
        await openDB();
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).put({ date, mood });
        await tx.complete;
    }
    </script>
</body>
</html>
