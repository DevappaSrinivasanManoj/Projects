<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Book & Movie Tracker</title>
    <style>
        /* Combined Vintage/Bright Theme */
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #f5f5dc; /* Beige background from v3 */
            color: #3a3a3a; /* Dark text from v3 */
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fffaf0; /* Floral white from v3 */
            padding: 20px;
            border: 2px solid #8B4513; /* SaddleBrown from v4 */
            box-shadow: 5px 5px 10px rgba(0,0,0,0.2); /* Shadow from v4 */
            border-radius: 5px;
        }
        h1, h2 {
            font-family: 'Georgia', serif; /* Font from v4 */
            text-align: center;
            color: #8B4513; /* SaddleBrown from v4 */
            border-bottom: 3px double #8B4513; /* Double border from v4 */
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        nav {
            text-align: center;
            margin-bottom: 20px;
        }
        button {
            background-color: #DAA520; /* GoldenRod from v4 */
            color: #ffffff;
            border: 1px solid #8B4513; /* SaddleBrown from v4 */
            padding: 12px 22px;
            margin: 0 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        button:hover, button.active {
            background-color: #B8860B; /* DarkGoldenRod from v4 */
            transform: translateY(-2px);
        }
        input[type="text"] {
            background-color: #ffffff;
            border: 1px solid #ccc;
            color: #000000;
            font-family: inherit;
            font-size: 16px;
            padding: 10px;
            width: calc(50% - 24px);
            margin-right: 10px;
            border-radius: 5px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #DAA520; /* GoldenRod from v4 */
            box-shadow: 0 0 5px #DAA520;
        }
        .rating {
            display: inline-block;
            color: #DAA520; /* GoldenRod from v4 */
            font-size: 28px;
        }
        .rating .star {
            cursor: pointer;
            padding: 0 3px;
        }
        #add-book-form, #add-movie-form {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px dashed #DAA520; /* GoldenRod from v4 */
            background-color: #fafad2; /* LightGoldenRodYellow from v4 */
            border-radius: 5px;
        }
        .list-item {
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
            border-radius: 5px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }
        .list-item h3 {
            margin-top: 0;
            color: #B8860B; /* DarkGoldenRod from v4 */
        }
        .list-item button {
            background-color: #dc143c; /* Crimson from v4 */
            color: #fff;
            border: 1px solid #8b0000; /* Dark Red from v4 */
        }
        .list-item button:hover {
            background-color: #8b0000; /* Dark Red from v4 */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Retro Book & Movie Tracker</h1>
        <div class="io-buttons">
            <button id="export-btn">Export Data</button>
            <input type="file" id="import-file" accept=".json" style="display: none;">
            <button id="import-btn">Import Data</button>
        </div>
        <nav>
            <button id="books-btn">Books</button>
            <button id="movies-btn">Movies</button>
        </nav>
        <div id="content">
            <!-- App content will be dynamically generated here -->
        </div>
    </div>

    <script>
        // --- Database Setup ---
        const DB_NAME = 'RetroTrackerDB';
        const DB_VERSION = 1;
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    // Create Books object store
                    if (!db.objectStoreNames.contains('books')) {
                        const booksStore = db.createObjectStore('books', { keyPath: 'id', autoIncrement: true });
                        booksStore.createIndex('title', 'title', { unique: false });
                        booksStore.createIndex('author', 'author', { unique: false });
                        booksStore.createIndex('rating', 'rating', { unique: false });
                        booksStore.createIndex('finishedDate', 'finishedDate', { unique: false });
                    }

                    // Create Movies object store
                    if (!db.objectStoreNames.contains('movies')) {
                        const moviesStore = db.createObjectStore('movies', { keyPath: 'id', autoIncrement: true });
                        moviesStore.createIndex('title', 'title', { unique: false });
                        moviesStore.createIndex('director', 'director', { unique: false });
                        moviesStore.createIndex('rating', 'rating', { unique: false });
                        moviesStore.createIndex('watchedDate', 'watchedDate', { unique: false });
                        moviesStore.createIndex('watchedYear', 'watchedYear', { unique: false });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('Database initialized successfully.');
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error('Database error:', event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        // --- Data Functions ---

        function addItem(storeName, item) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(item);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getAllItems(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteItem(storeName, id) {
             return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }


        """        // --- App Logic ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                // Default to showing the books view
                await showBooksView();

                document.getElementById('export-btn').addEventListener('click', exportData);
                document.getElementById('import-btn').addEventListener('click', () => {
                    document.getElementById('import-file').click();
                });
                document.getElementById('import-file').addEventListener('change', importData);

            } catch (error) {
                console.error('Error initializing app:', error);
                document.getElementById('content').innerHTML = '<p>Error: Could not initialize the database.</p>';
            }

            document.getElementById('books-btn').addEventListener('click', showBooksView);
            document.getElementById('movies-btn').addEventListener('click', showMoviesView);
        });""

        async function showBooksView() {
            document.getElementById('content').innerHTML = `
                <h2>My Books</h2>
                <div class="controls">
                    <input type="text" id="book-search" placeholder="Search by title...">
                    <select id="author-filter"><option value="">All Authors</option></select>
                    <select id="rating-filter"><option value="">All Ratings</option></select>
                </div>
                <div id="add-book-form">
                    <input type="text" id="book-title" placeholder="Book Title">
                    <input type="text" id="book-author" placeholder="Author">
                    <div class="rating">
                        <span>Rating:</span>
                        <span class="star" data-value="1">☆</span>
                        <span class="star" data-value="2">☆</span>
                        <span class="star" data-value="3">☆</span>
                        <span class="star" data-value="4">☆</span>
                        <span class="star" data-value="5">☆</span>
                    </div>
                    <input type="hidden" id="book-rating" value="0">
                    <button id="add-book-btn">Add Book</button>
                </div>
                <div id="book-list"></div>
            `;
            await updateBookFilters();
            await renderBooks();
            setupBookForm();
            setupBookFilters();
        }

        async function showMoviesView() {
            document.getElementById('content').innerHTML = `
                <h2>My Movies</h2>
                <div class="controls">
                    <input type="text" id="movie-search" placeholder="Search by title...">
                    <select id="director-filter"><option value="">All Directors</option></select>
                    <select id="movie-rating-filter"><option value="">All Ratings</option></select>
                    <select id="year-filter"><option value="">All Years</option></select>
                </div>
                <div id="add-movie-form">
                    <input type="text" id="movie-title" placeholder="Movie Title">
                    <input type="text" id="movie-director" placeholder="Director">
                     <div class="rating">
                        <span>Rating:</span>
                        <span class="star" data-value="1">☆</span>
                        <span class="star" data-value="2">☆</span>
                        <span class="star" data-value="3">☆</span>
                        <span class="star" data-value="4">☆</span>
                        <span class="star" data-value="5">☆</span>
                    </div>
                    <input type="hidden" id="movie-rating" value="0">
                    <button id="add-movie-btn">Add Movie</button>
                </div>
                <div id="movie-list"></div>
            `;
            await updateMovieFilters();
            await renderMovies();
            setupMovieForm();
            setupMovieFilters();
        }

        function setupBookForm() {
            document.getElementById('add-book-btn').addEventListener('click', async () => {
                const title = document.getElementById('book-title').value;
                const author = document.getElementById('book-author').value;
                const rating = parseInt(document.getElementById('book-rating').value, 10);

                if (title && author && rating > 0) {
                    const newBook = {
                        title,
                        author,
                        rating,
                        finishedDate: new Date()
                    };
                    await addItem('books', newBook);
                    document.getElementById('book-title').value = '';
                    document.getElementById('book-author').value = '';
                    document.getElementById('book-rating').value = '0';
                    resetStars();
                    await updateBookFilters();
                    await renderBooks();
                } else {
                    alert('Please fill out all fields and provide a rating.');
                }
            });
            setupRatingStars('book-rating');
        }

        function setupMovieForm() {
            document.getElementById('add-movie-btn').addEventListener('click', async () => {
                const title = document.getElementById('movie-title').value;
                const director = document.getElementById('movie-director').value;
                const rating = parseInt(document.getElementById('movie-rating').value, 10);

                if (title && director && rating > 0) {
                    const watchedDate = new Date();
                    const newMovie = {
                        title,
                        director,
                        rating,
                        watchedDate,
                        watchedYear: watchedDate.getFullYear()
                    };
                    await addItem('movies', newMovie);
                    document.getElementById('movie-title').value = '';
                    document.getElementById('movie-director').value = '';
                    document.getElementById('movie-rating').value = '0';
                    resetStars();
                    await updateMovieFilters();
                    await renderMovies();
                } else {
                    alert('Please fill out all fields and provide a rating.');
                }
            });
            setupRatingStars('movie-rating');
        }

        async function updateBookFilters() {
            const books = await getAllItems('books');
            const authorFilter = document.getElementById('author-filter');
            const ratingFilter = document.getElementById('rating-filter');

            const authors = [...new Set(books.map(b => b.author))].sort();
            const ratings = [...new Set(books.map(b => b.rating))].sort((a, b) => a - b);

            const selectedAuthor = authorFilter.value;
            const selectedRating = ratingFilter.value;

            authorFilter.innerHTML = '<option value="">All Authors</option>' + authors.map(a => `<option value="${a}">${a}</option>`).join('');
            ratingFilter.innerHTML = '<option value="">All Ratings</option>' + ratings.map(r => `<option value="${r}">${r} star${r > 1 ? 's' : ''}</option>`).join('');

            authorFilter.value = selectedAuthor;
            ratingFilter.value = selectedRating;
        }

        async function updateMovieFilters() {
            const movies = await getAllItems('movies');
            const directorFilter = document.getElementById('director-filter');
            const movieRatingFilter = document.getElementById('movie-rating-filter');
            const yearFilter = document.getElementById('year-filter');

            const directors = [...new Set(movies.map(m => m.director))].sort();
            const movieRatings = [...new Set(movies.map(m => m.rating))].sort((a, b) => a - b);
            const years = [...new Set(movies.map(m => m.watchedYear))].sort((a, b) => b - a);

            const selectedDirector = directorFilter.value;
            const selectedRating = movieRatingFilter.value;
            const selectedYear = yearFilter.value;

            directorFilter.innerHTML = '<option value="">All Directors</option>' + directors.map(d => `<option value="${d}">${d}</option>`).join('');
            movieRatingFilter.innerHTML = '<option value="">All Ratings</option>' + movieRatings.map(r => `<option value="${r}">${r} star${r > 1 ? 's' : ''}</option>`).join('');
            yearFilter.innerHTML = '<option value="">All Years</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');

            directorFilter.value = selectedDirector;
            movieRatingFilter.value = selectedRating;
            yearFilter.value = selectedYear;
        }
        
        async function renderBooks() {
            const bookListDiv = document.getElementById('book-list');
            let books = await getAllItems('books');

            // Apply filters
            const searchTerm = document.getElementById('book-search').value.toLowerCase();
            const selectedAuthor = document.getElementById('author-filter').value;
            const selectedRating = document.getElementById('rating-filter').value;

            if (searchTerm) {
                books = books.filter(b => b.title.toLowerCase().includes(searchTerm));
            }
            if (selectedAuthor) {
                books = books.filter(b => b.author === selectedAuthor);
            }
            if (selectedRating) {
                books = books.filter(b => b.rating == selectedRating);
            }

            books.sort((a, b) => new Date(b.finishedDate) - new Date(a.finishedDate));

            bookListDiv.innerHTML = books.map(book => `
                <div class="list-item">
                    <h3>${book.title}</h3>
                    <p>by ${book.author}</p>
                    <p>Finished: ${new Date(book.finishedDate).toLocaleDateString()}</p>
                    <p>Rating: ${'★'.repeat(book.rating)}${'☆'.repeat(5 - book.rating)}</p>
                    <button onclick="deleteBook(${book.id})">Delete</button>
                </div>
            `).join('');
        }

        async function renderMovies() {
            const movieListDiv = document.getElementById('movie-list');
            let movies = await getAllItems('movies');

            // Apply filters
            const searchTerm = document.getElementById('movie-search').value.toLowerCase();
            const selectedDirector = document.getElementById('director-filter').value;
            const selectedRating = document.getElementById('movie-rating-filter').value;
            const selectedYear = document.getElementById('year-filter').value;

            if (searchTerm) {
                movies = movies.filter(m => m.title.toLowerCase().includes(searchTerm));
            }
            if (selectedDirector) {
                movies = movies.filter(m => m.director === selectedDirector);
            }
            if (selectedRating) {
                movies = movies.filter(m => m.rating == selectedRating);
            }
            if (selectedYear) {
                movies = movies.filter(m => m.watchedYear == selectedYear);
            }

            movies.sort((a, b) => new Date(b.watchedDate) - new Date(a.watchedDate));

            movieListDiv.innerHTML = movies.map(movie => `
                <div class="list-item">
                    <h3>${movie.title}</h3>
                    <p>directed by ${movie.director}</p>
                    <p>Watched: ${new Date(movie.watchedDate).toLocaleDateString()}</p>
                    <p>Rating: ${'★'.repeat(movie.rating)}${'☆'.repeat(5 - movie.rating)}</p>
                    <button onclick="deleteMovie(${movie.id})">Delete</button>
                </div>
            `).join('');
        }

        async function deleteBook(id) {
            if (confirm('Are you sure you want to delete this book?')) {
                await deleteItem('books', id);
                await renderBooks();
            }
        }

        async function deleteMovie(id) {
            if (confirm('Are you sure you want to delete this movie?')) {
                await deleteItem('movies', id);
                await renderMovies();
            }
        }

        function setupRatingStars(ratingInputId) {
            const stars = document.querySelectorAll('.rating .star');
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const value = star.getAttribute('data-value');
                    document.getElementById(ratingInputId).value = value;
                    stars.forEach(s => {
                        s.innerHTML = s.getAttribute('data-value') <= value ? '★' : '☆';
                    });
                });
            });
        }
        
        function resetStars() {
            const stars = document.querySelectorAll('.rating .star');
            stars.forEach(star => {
                star.innerHTML = '☆';
            });
        }

        // --- Filtering and Searching ---
        function setupBookFilters() {
            document.getElementById('book-search').addEventListener('input', renderBooks);
            document.getElementById('author-filter').addEventListener('change', renderBooks);
            document.getElementById('rating-filter').addEventListener('change', renderBooks);
        }

        function setupMovieFilters() {
            document.getElementById('movie-search').addEventListener('input', renderMovies);
            document.getElementById('director-filter').addEventListener('change', renderMovies);
            document.getElementById('movie-rating-filter').addEventListener('change', renderMovies);
            document.getElementById('year-filter').addEventListener('change', renderMovies);
        }

        // --- Import/Export ---
        async function exportData() {
            const books = await getAllItems('books');
            const movies = await getAllItems('movies');
            const data = { books, movies };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'retro_tracker_backup.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.books) {
                        for (const book of data.books) {
                            await addItem('books', book);
                        }
                    }
                    if (data.movies) {
                        for (const movie of data.movies) {
                            await addItem('movies', movie);
                        }
                    }
                    alert('Data imported successfully!');
                    // Refresh the current view
                    if (document.getElementById('book-list')) {
                        await renderBooks();
                    } else if (document.getElementById('movie-list')) {
                        await renderMovies();
                    }
                } catch (error) {
                    console.error('Error importing data:', error);
                    alert('Error importing data. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>