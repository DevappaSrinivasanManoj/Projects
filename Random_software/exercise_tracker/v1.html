<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra Modern Exercise Tracker</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #232526, #414345);
            color: #fff;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 500px;
            margin: 40px auto;
            background: rgba(30, 30, 30, 0.95);
            border-radius: 18px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            padding: 32px 24px 24px 24px;
        }
        h1 {
            text-align: center;
            font-size: 2.2em;
            margin-bottom: 18px;
            letter-spacing: 1px;
        }
        .tracker-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }
        select, button {
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 1em;
        }
        button {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: linear-gradient(90deg, #0072ff, #00c6ff);
        }
        .history {
            margin-top: 24px;
        }
        .history-title {
            font-size: 1.1em;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .history-list li {
            background: rgba(255,255,255,0.05);
            margin-bottom: 8px;
            padding: 10px 14px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .streak {
            margin-top: 18px;
            font-size: 1.2em;
            text-align: center;
            color: #00e676;
            font-weight: bold;
        }
        .actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 18px;
        }
        input[type="file"] {
            display: none;
        }
        label[for="importFile"] {
            background: linear-gradient(90deg, #ff512f, #dd2476);
            color: #fff;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        label[for="importFile"]:hover {
            background: linear-gradient(90deg, #dd2476, #ff512f);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Exercise Tracker</h1>
        <form class="tracker-form" id="trackerForm">
            <select id="exerciseType" required>
                <option value="" disabled selected>Select Exercise Type</option>
                <option value="strength">Power/Strength</option>
                <option value="skipping">Skipping</option>
                <option value="cycling">Cycling</option>
            </select>
            <select id="strengthSub" style="display:none;">
                <option value="" disabled selected>Select Sub-category</option>
                <option value="chest">Chest</option>
                <option value="biceps">Biceps</option>
                <option value="free">Free Plan (All)</option>
            </select>
            <button type="submit">Mark Today's Exercise</button>
        </form>
        <div class="actions">
            <button id="exportBtn">Export CSV</button>
            <label for="importFile">Import CSV</label>
            <input type="file" id="importFile" accept=".csv">
        </div>
        <div class="streak" id="streak"></div>
        <div class="history">
            <div class="history-title">History (Last 365 Days)</div>
            <ul class="history-list" id="historyList"></ul>
        </div>
    </div>
    <script>
        // IndexedDB setup
        const DB_NAME = 'exercise_tracker_db';
        const DB_VERSION = 1;
        const STORE_NAME = 'exercises';
        const MAX_RECORDS = 365;
        let db;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = function(e) {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'date' });
                    }
                };
                request.onsuccess = function(e) {
                    db = e.target.result;
                    resolve(db);
                };
                request.onerror = function(e) {
                    reject(e);
                };
            });
        }

        function addExercise(record) {
            return new Promise(async (resolve, reject) => {
                await openDB();
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.put(record);
                tx.oncomplete = async function() {
                    await enforceMaxRecords();
                    resolve();
                };
                tx.onerror = function(e) {
                    reject(e);
                };
            });
        }

        function getAllExercises() {
            return new Promise(async (resolve, reject) => {
                await openDB();
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = function(e) {
                    resolve(e.target.result.sort((a, b) => new Date(a.date) - new Date(b.date)));
                };
                request.onerror = function(e) {
                    reject(e);
                };
            });
        }

        function deleteOldestExercise() {
            return new Promise(async (resolve, reject) => {
                const all = await getAllExercises();
                if (all.length > 0) {
                    const oldest = all[0];
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    store.delete(oldest.date);
                    tx.oncomplete = function() { resolve(); };
                    tx.onerror = function(e) { reject(e); };
                } else {
                    resolve();
                }
            });
        }

        async function enforceMaxRecords() {
            const all = await getAllExercises();
            while (all.length > MAX_RECORDS) {
                await deleteOldestExercise();
                all.shift();
            }
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString();
        }

        function getTodayISO() {
            const d = new Date();
            d.setHours(0,0,0,0);
            return d.toISOString().split('T')[0];
        }

        function updateHistory() {
            getAllExercises().then(records => {
                const list = document.getElementById('historyList');
                list.innerHTML = '';
                records.forEach(r => {
                    let desc = '';
                    if (r.type === 'strength') {
                        desc = `Power/Strength (${r.sub})`;
                    } else if (r.type === 'skipping') {
                        desc = 'Skipping';
                    } else if (r.type === 'cycling') {
                        desc = 'Cycling';
                    }
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${formatDate(r.date)}: <b>${desc}</b></span>`;
                    list.appendChild(li);
                });
                updateStreak(records);
            });
        }

        function updateStreak(records) {
            if (!records || records.length === 0) {
                document.getElementById('streak').textContent = 'No streak yet!';
                return;
            }
            // Calculate streak
            let streak = 1;
            let prev = new Date(records[records.length - 1].date);
            for (let i = records.length - 2; i >= 0; i--) {
                const curr = new Date(records[i].date);
                const diff = (prev - curr) / (1000 * 60 * 60 * 24);
                if (diff === 1) {
                    streak++;
                    prev = curr;
                } else if (diff > 1) {
                    break;
                }
            }
            document.getElementById('streak').textContent = `Current Streak: ${streak} day${streak > 1 ? 's' : ''}`;
        }

        document.getElementById('exerciseType').addEventListener('change', function() {
            const val = this.value;
            document.getElementById('strengthSub').style.display = val === 'strength' ? 'block' : 'none';
        });

        document.getElementById('trackerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const type = document.getElementById('exerciseType').value;
            let sub = '';
            if (type === 'strength') {
                sub = document.getElementById('strengthSub').value;
                if (!sub) {
                    alert('Please select a sub-category for Power/Strength.');
                    return;
                }
            }
            const today = getTodayISO();
            const record = { date: today, type, sub };
            await addExercise(record);
            updateHistory();
        });

        // Export CSV
        document.getElementById('exportBtn').addEventListener('click', async function() {
            const records = await getAllExercises();
            let csv = 'date,type,sub\n';
            records.forEach(r => {
                csv += `${r.date},${r.type},${r.sub || ''}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'exercise_backup.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Import CSV
        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(ev) {
                const text = ev.target.result;
                const lines = text.split('\n').filter(l => l.trim().length > 0);
                if (lines[0].toLowerCase().includes('date')) lines.shift();
                let imported = [];
                for (const line of lines) {
                    const [date, type, sub] = line.split(',');
                    if (date && type) {
                        imported.push({ date, type, sub });
                    }
                }
                // Remove all existing records, then add imported
                await openDB();
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.clear();
                tx.oncomplete = async function() {
                    for (const rec of imported) {
                        await addExercise(rec);
                    }
                    updateHistory();
                };
            };
            reader.readAsText(file);
        });

        // Initial load
        openDB().then(updateHistory);
    </script>
</body>
</html>
