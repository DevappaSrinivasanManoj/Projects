<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mood Tracker App</title>
  <style>
    /* Removed Google Fonts for offline use */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #232526 0%, #414345 100%);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .container {
      width: 100%;
      max-width: 500px;
      margin: 32px auto;
      background: rgba(30,30,40,0.95);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      padding: 32px 24px 24px 24px;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }
    h1 {
      text-align: center;
      font-size: 2.2rem;
      letter-spacing: 2px;
      margin-bottom: 0.5em;
      color: #00e6d0;
      text-shadow: 0 2px 8px #0008;
    }
    .section {
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 1.2rem;
      margin-bottom: 8px;
      color: #00e6d0;
      letter-spacing: 1px;
    }
    .features-list, .mood-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .feature-item, .mood-item {
      background: #232526;
      border-radius: 12px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
      box-shadow: 0 2px 8px #0002;
    }
    .feature-item input[type="checkbox"] {
      accent-color: #00e6d0;
      width: 18px;
      height: 18px;
    }
    .add-feature-form, .add-mood-form {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .add-feature-form input, .add-mood-form input {
      border: none;
      border-radius: 8px;
      padding: 8px;
      font-size: 1rem;
      outline: none;
      background: #2d2f36;
      color: #fff;
    }
    .add-feature-form select {
      border: none;
      border-radius: 8px;
      padding: 8px;
      font-size: 1rem;
      background: #2d2f36;
      color: #fff;
    }
    .add-feature-form button, .add-mood-form button, .export-btn, .import-btn {
      background: linear-gradient(90deg, #00e6d0 0%, #007cf0 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    .add-feature-form button:hover, .add-mood-form button:hover, .export-btn:hover, .import-btn:hover {
      background: linear-gradient(90deg, #007cf0 0%, #00e6d0 100%);
    }
    .delete-btn {
      background: #ff3b3b;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-left: 4px;
      transition: background 0.2s;
    }
    .delete-btn:hover {
      background: #c62828;
    }
    .move-up-btn, .move-down-btn {
      background: #444;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-left: 2px;
      transition: background 0.2s;
    }
    .move-up-btn:hover, .move-down-btn:hover {
      background: #00e6d0;
      color: #232526;
    }
    .export-import-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      margin-top: 16px;
    }
    .export-btn, .import-btn {
      width: 100%;
      margin-bottom: 4px;
    }
    .day-section {
      margin-top: 16px;
      background: #232526;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px #0002;
    }
    .day-date {
      font-size: 1.1rem;
      color: #00e6d0;
      margin-bottom: 8px;
      text-align: center;
    }
    .save-day-btn {
      background: linear-gradient(90deg, #00e6d0 0%, #007cf0 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
      margin-top: 8px;
      transition: background 0.2s;
    }
    .save-day-btn:hover {
      background: linear-gradient(90deg, #007cf0 0%, #00e6d0 100%);
    }
    .history-section {
      margin-top: 24px;
      background: #232526;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px #0002;
      max-height: 200px;
      overflow-y: auto;
    }
    .history-title {
      color: #00e6d0;
      font-size: 1.1rem;
      margin-bottom: 8px;
    }
    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .history-list li {
      margin-bottom: 6px;
      font-size: 0.98rem;
      color: #fff;
      background: #2d2f36;
      border-radius: 8px;
      padding: 6px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .history-list .mood {
      font-weight: bold;
      color: #00e6d0;
    }
    @media (max-width: 600px) {
      .container {
        padding: 16px 4px 12px 4px;
        max-width: 98vw;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Mood Tracker</h1>
    <!-- Features Section -->
    <div class="section" id="features-section">
      <div class="section-title" id="features-toggle" style="cursor:pointer;user-select:none;">▶ Daily Habits</div>
      <div id="features-content" style="display:none;">
        <form class="add-feature-form" id="add-feature-form">
          <input type="text" id="feature-name" placeholder="Add new habit..." required maxlength="32">
          <select id="feature-default">
            <option value="yes">Default: Yes</option>
            <option value="no">Default: No</option>
          </select>
          <button type="submit">Add</button>
        </form>
        <div class="features-list" id="features-list"></div>
      </div>
    </div>
    <!-- Mood Section -->
    <div class="section" id="mood-section">
      <div class="section-title" id="mood-toggle" style="cursor:pointer;user-select:none;">▶ Mood Categories</div>
      <div id="mood-content" style="display:none;">
        <form class="add-mood-form" id="add-mood-form">
          <input type="text" id="mood-name" placeholder="Add new mood..." required maxlength="20">
          <button type="submit">Add</button>
        </form>
        <div class="mood-list" id="mood-list"></div>
      </div>
    </div>
    <!-- Day Section -->
    <div class="day-section" id="day-section">
      <div class="day-date" id="day-date"></div>
      <div class="features-list" id="day-features-list"></div>
      <div class="mood-list" id="day-mood-list"></div>
      <button class="save-day-btn" id="save-day-btn">Save Day</button>
    </div>
    <!-- Export/Import Section -->
    <div class="export-import-section">
      <button class="export-btn" id="export-btn">Export Data (CSV)</button>
      <input type="file" id="import-input" style="display:none" accept=".csv">
      <button class="import-btn" id="import-btn">Import Data (CSV)</button>
    </div>
    <!-- History Section -->
    <div class="history-section" id="history-section">
      <div class="history-title" id="history-toggle" style="cursor:pointer;user-select:none;">▶ Recent Entries</div>
      <div id="history-content" style="display:none;">
        <ul class="history-list" id="history-list"></ul>
      </div>
    </div>
  </div>
  <script>
    // IndexedDB setup
    const DB_NAME = 'moodtracker';
    const DB_VERSION = 1;
    let db;
    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = function(e) {
          db = e.target.result;
          if (!db.objectStoreNames.contains('features')) {
            db.createObjectStore('features', { keyPath: 'id', autoIncrement: true });
          }
          if (!db.objectStoreNames.contains('moods')) {
            db.createObjectStore('moods', { keyPath: 'id', autoIncrement: true });
          }
          if (!db.objectStoreNames.contains('days')) {
            db.createObjectStore('days', { keyPath: 'date' });
          }
        };
        req.onsuccess = function(e) {
          db = e.target.result;
          resolve(db);
        };
        req.onerror = function(e) {
          reject(e);
        };
      });
    }
    // Utility for IDB
    function idbGetAll(store) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction([store], 'readonly');
        const st = tx.objectStore(store);
        const req = st.getAll();
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    function idbAdd(store, value) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction([store], 'readwrite');
        const st = tx.objectStore(store);
        const req = st.add(value);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    function idbPut(store, value) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction([store], 'readwrite');
        const st = tx.objectStore(store);
        const req = st.put(value);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    function idbDelete(store, key) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction([store], 'readwrite');
        const st = tx.objectStore(store);
        const req = st.delete(key);
        req.onsuccess = () => resolve();
        req.onerror = () => reject(req.error);
      });
    }
    // For moods, keep an order field
    function idbGetAllOrdered(store) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction([store], 'readonly');
        const st = tx.objectStore(store);
        const req = st.getAll();
        req.onsuccess = () => {
          if (store === 'moods') {
            resolve(req.result.sort((a, b) => a.order - b.order));
          } else {
            resolve(req.result);
          }
        };
        req.onerror = () => reject(req.error);
      });
    }
    // UI State
    let features = [];
    let moods = [];
    let today = new Date().toISOString().slice(0,10);
    let dayData = {};
    // Default moods
    const DEFAULT_MOODS = [
      { name: 'Excellent', order: 1 },
      { name: 'Good', order: 2 },
      { name: 'Neutral', order: 3 },
      { name: 'Bad', order: 4 },
      { name: 'Worst', order: 5 }
    ];
    // --- Initialization ---
    openDB().then(async () => {
      // Seed moods if not present
      let moodsInDB = await idbGetAll('moods');
      if (!moodsInDB.length) {
        for (let i = 0; i < DEFAULT_MOODS.length; i++) {
          await idbAdd('moods', { ...DEFAULT_MOODS[i] });
        }
      }
      await refreshFeatures();
      await refreshMoods();
      await refreshDay();
      await refreshHistory();
    });
    // --- Features Section ---
    async function refreshFeatures() {
      features = await idbGetAll('features');
      renderFeatures();
      renderDayFeatures();
    }
    function renderFeatures() {
      const list = document.getElementById('features-list');
      list.innerHTML = '';
      features.forEach(f => {
        const div = document.createElement('div');
        div.className = 'feature-item';
        div.innerHTML = `<span>${f.name}</span> <span style="font-size:0.9em;color:#aaa;">(Default: ${f.default === 'yes' ? 'Yes' : 'No'})</span>`;
        const del = document.createElement('button');
        del.className = 'delete-btn';
        del.textContent = '✕';
        del.onclick = async () => {
          await idbDelete('features', f.id);
          await refreshFeatures();
        };
        div.appendChild(del);
        list.appendChild(div);
      });
    }
    document.getElementById('add-feature-form').onsubmit = async (e) => {
      e.preventDefault();
      const name = document.getElementById('feature-name').value.trim();
      const def = document.getElementById('feature-default').value;
      if (!name) return;
      await idbAdd('features', { name, default: def });
      document.getElementById('feature-name').value = '';
      await refreshFeatures();
    };
    // --- Moods Section ---
    async function refreshMoods() {
      moods = await idbGetAllOrdered('moods');
      renderMoods();
      renderDayMoods();
    }
    function renderMoods() {
      const list = document.getElementById('mood-list');
      list.innerHTML = '';
      moods.forEach((m, idx) => {
        const div = document.createElement('div');
        div.className = 'mood-item';
        div.innerHTML = `<span>${m.name}</span>`;
        // Move up/down
        const up = document.createElement('button');
        up.className = 'move-up-btn';
        up.textContent = '↑';
        up.disabled = idx === 0;
        up.onclick = async () => {
          if (idx === 0) return;
          const prev = moods[idx-1];
          await idbPut('moods', { ...m, order: prev.order });
          await idbPut('moods', { ...prev, order: m.order });
          await refreshMoods();
        };
        div.appendChild(up);
        const down = document.createElement('button');
        down.className = 'move-down-btn';
        down.textContent = '↓';
        down.disabled = idx === moods.length-1;
        down.onclick = async () => {
          if (idx === moods.length-1) return;
          const next = moods[idx+1];
          await idbPut('moods', { ...m, order: next.order });
          await idbPut('moods', { ...next, order: m.order });
          await refreshMoods();
        };
        div.appendChild(down);
        // Delete
        const del = document.createElement('button');
        del.className = 'delete-btn';
        del.textContent = '✕';
        del.onclick = async () => {
          await idbDelete('moods', m.id);
          await refreshMoods();
        };
        div.appendChild(del);
        list.appendChild(div);
      });
    }
    document.getElementById('add-mood-form').onsubmit = async (e) => {
      e.preventDefault();
      const name = document.getElementById('mood-name').value.trim();
      if (!name) return;
      let maxOrder = moods.length ? Math.max(...moods.map(m => m.order)) : 0;
      await idbAdd('moods', { name, order: maxOrder+1 });
      document.getElementById('mood-name').value = '';
      await refreshMoods();
    };
    // --- Day Section ---
    async function refreshDay() {
      document.getElementById('day-date').textContent = `Today: ${today}`;
      // Load today's data
      const tx = db.transaction(['days'], 'readonly');
      const st = tx.objectStore('days');
      const req = st.get(today);
      req.onsuccess = async () => {
        dayData = req.result || { date: today, features: {}, mood: null };
        renderDayFeatures();
        renderDayMoods();
      };
    }
    function renderDayFeatures() {
      const list = document.getElementById('day-features-list');
      list.innerHTML = '';
      features.forEach(f => {
        const div = document.createElement('div');
        div.className = 'feature-item';
        const label = document.createElement('label');
        label.textContent = f.name;
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = dayData.features && dayData.features[f.id] !== undefined ? dayData.features[f.id] : (f.default === 'yes');
        cb.onchange = () => {
          if (!dayData.features) dayData.features = {};
          dayData.features[f.id] = cb.checked;
        };
        div.appendChild(cb);
        div.appendChild(label);
        list.appendChild(div);
      });
    }
    function renderDayMoods() {
      const list = document.getElementById('day-mood-list');
      list.innerHTML = '';
      moods.forEach(m => {
        const div = document.createElement('div');
        div.className = 'mood-item';
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'day-mood';
        radio.value = m.id;
        radio.checked = dayData.mood === m.id;
        radio.onchange = () => {
          dayData.mood = m.id;
        };
        div.appendChild(radio);
        div.appendChild(document.createTextNode(m.name));
        list.appendChild(div);
      });
    }
    document.getElementById('save-day-btn').onclick = async () => {
      if (!dayData.mood) {
        alert('Please select a mood for today!');
        return;
      }
      await idbPut('days', { ...dayData, date: today });
      await refreshHistory();
      alert('Day saved!');
    };
    // --- History Section ---
    async function refreshHistory() {
      const tx = db.transaction(['days'], 'readwrite');
      const st = tx.objectStore('days');
      const req = st.getAll();
      req.onsuccess = async () => {
        let days = req.result.sort((a, b) => b.date.localeCompare(a.date));
        // Keep only last 365 days
        const now = new Date();
        const cutoff = new Date(now.getTime() - 365*24*60*60*1000);
        let toDelete = days.filter(d => new Date(d.date) < cutoff);
        for (let d of toDelete) {
          await idbDelete('days', d.date);
        }
        days = days.filter(d => new Date(d.date) >= cutoff);
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        for (let d of days.slice(0, 14)) {
          const li = document.createElement('li');
          const moodName = moods.find(m => m.id === d.mood)?.name || 'Unknown';
          li.innerHTML = `<span>${d.date}</span> <span class="mood">${moodName}</span>`;
          list.appendChild(li);
        }
      };
    }
    // --- Export/Import Section ---
    document.getElementById('export-btn').onclick = async () => {
      // Export all days as CSV
      const tx = db.transaction(['days'], 'readonly');
      const st = tx.objectStore('days');
      const req = st.getAll();
      req.onsuccess = async () => {
        let days = req.result;
        let featureMap = {};
        features.forEach(f => featureMap[f.id] = f.name);
        let moodMap = {};
        moods.forEach(m => moodMap[m.id] = m.name);
        let csv = 'date,mood,' + features.map(f => '"' + f.name + '"').join(',') + '\n';
        for (let d of days) {
          let row = [d.date, moodMap[d.mood] || ''];
          features.forEach(f => {
            const state = d.features ? d.features[f.id] : undefined;
            if (state !== undefined) {
              row.push(state ? 'Yes' : 'No');
            } else {
              row.push(f.default === 'yes' ? 'Yes' : 'No');
            }
          });
          csv += row.join(',') + '\n';
        }
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'moodtracker_export.csv';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
        // Ask to clear data after export
        if (confirm('Do you want to clear all data after export?')) {
          // Clear all days
          const tx2 = db.transaction(['days'], 'readwrite');
          const st2 = tx2.objectStore('days');
          const clearReq = st2.clear();
          clearReq.onsuccess = async () => {
            await refreshHistory();
            await refreshDay();
            alert('All data cleared!');
          };
        }
      };
    };
    // --- Collapsible Sections ---
    function toggleSection(section) {
      let content, title;
      if (section === 'features') {
        content = document.getElementById('features-content');
        title = document.getElementById('features-toggle');
      } else if (section === 'mood') {
        content = document.getElementById('mood-content');
        title = document.getElementById('mood-toggle');
      } else if (section === 'history') {
        content = document.getElementById('history-content');
        title = document.getElementById('history-toggle');
      }
      if (!content || !title) return;
      // Use inline style to check visibility (fix for expand/collapse)
      const isHidden = content.style.display === 'none';
      if (isHidden) {
        content.style.display = 'block';
        if (title.innerHTML.includes('▶')) title.innerHTML = title.innerHTML.replace('▶', '▼');
      } else {
        content.style.display = 'none';
        if (title.innerHTML.includes('▼')) title.innerHTML = title.innerHTML.replace('▼', '▶');
      }
    }
    // Expand day section by default, collapse others
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('features-content').style.display = 'none';
      document.getElementById('features-toggle').innerHTML = '▶ Daily Habits';
      document.getElementById('mood-content').style.display = 'none';
      document.getElementById('mood-toggle').innerHTML = '▶ Mood Categories';
      document.getElementById('history-content').style.display = 'none';
      document.getElementById('history-toggle').innerHTML = '▶ Recent Entries';

      document.getElementById('features-toggle').addEventListener('click', function() { toggleSection('features'); });
      document.getElementById('mood-toggle').addEventListener('click', function() { toggleSection('mood'); });
      document.getElementById('history-toggle').addEventListener('click', function() { toggleSection('history'); });
    });
    document.getElementById('import-btn').onclick = () => {
      document.getElementById('import-input').click();
    };
    document.getElementById('import-input').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      const lines = text.split(/\r?\n/).filter(l => l.trim());
      if (lines.length < 2) return alert('Invalid CSV');
      const header = lines[0].split(',').map(h => h.replace(/"/g, ''));
      const dateIdx = header.indexOf('date');
      const moodIdx = header.indexOf('mood');
      const featureIdxs = features.map(f => header.indexOf(f.name));
      for (let i = 1; i < lines.length; i++) {
        const row = lines[i].split(',');
        if (row.length < 2) continue;
        const date = row[dateIdx];
        const moodName = row[moodIdx];
        const mood = moods.find(m => m.name === moodName)?.id;
        let feats = {};
        features.forEach((f, idx) => {
          feats[f.id] = row[featureIdxs[idx]] === 'Yes';
        });
        if (date && mood) {
          await idbPut('days', { date, mood, features: feats });
        }
      }
      await refreshHistory();
      alert('Import complete!');
    };
  </script>
</body>
</html>
